_ulid: 01KEZCJPHVBKRZQ7VVBF84H51Z
slugs:
  - cli
  - cli-module
title: CLI Interface
type: module
status:
  maturity: draft
  implementation: implemented
description: |
  The kspec CLI is the primary interface to Kynetic Spec.
  Follows git's plumbing/porcelain model: low-level primitives
  for scripts/agents, high-level commands for humans.
features:
  - _ulid: 01KEZCJPHW3CSMXYZT01FP76BM
    slugs:
      - cli-design
    title: CLI Design Principles
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      The CLI is designed for both human and agent use.
      Consistent structure, predictable output, clear errors.
    requirements:
      - _ulid: 01KEZCJPHWP32HK8MR38P2WSSJ
        slugs:
          - cli-structure
        title: Command Structure
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Commands follow consistent structure:

          kspec <resource> <action> [args] [flags]

          Resources: item, task, link, todo, etc.
          Actions: add, get, list, set, delete, etc.

          Examples:
          - kspec item add --type feature --title "Login"
          - kspec task start @impl-login
          - kspec tasks ready
        implements:
          - "@cli-design"
      - _ulid: 01KEZCJPHWKVBFSAEP0MMH57DQ
        slugs:
          - cli-json-output
        title: JSON Output Mode
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          All commands support --json flag for structured output:

          kspec tasks ready --json
          kspec item get @login --json

          JSON output includes:
          - success: boolean
          - data: The result
          - errors: Array of error objects (if any)
        implements:
          - "@cli-design"
      - _ulid: 01KEZCJPHWB81SAWT4ZGCV75FC
        slugs:
          - cli-exit-codes
        title: Semantic Exit Codes
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Exit codes are semantic, not just 0/1:

          - 0: Success
          - 1: General error
          - 2: Usage error (bad arguments)
          - 3: Not found
          - 4: Validation failed
          - 5: Conflict (already exists, etc.)

          Scripts can handle specific cases.
        implements:
          - "@cli-design"
        acceptance_criteria:
          - id: exit-code-constants
            given: CLI codebase uses exit codes
            when: Commands need to exit with specific code
            then: Uses named constants from a centralized EXIT_CODES object (e.g., EXIT_CODES.NOT_FOUND instead
              of magic number 3)
          - id: exit-codes-documented
            given: User wants to script kspec commands
            when: User runs kspec help --exit-codes or checks documentation
            then: All exit codes are listed with their meanings and which commands may return them
          - id: consistent-usage
            given: Multiple commands use exit codes
            when: Commands exit with errors
            then: All commands use consistent exit codes for the same error types (e.g., all 'not found' errors
              exit 3, all validation errors exit 4)
        notes:
          - _ulid: 01KFADD1NW999DBZJHBDBSPFZM
            created_at: 2026-01-19T05:59:47.645Z
            author: "@claude"
            content: >-
              Enhancement: Formalize exit code implementation


              **Current state:** Exit codes are defined in spec but implementation uses magic
              numbers inconsistently.


              **Goals:**

              1. Centralized constants - single source of truth

              2. Documentation - help users script with kspec

              3. Consistency audit - ensure all commands follow the spec


              **Exit code definitions (from spec):**

              - 0: SUCCESS - Operation completed successfully

              - 1: ERROR - General/unexpected error

              - 2: USAGE - Bad arguments, invalid command usage

              - 3: NOT_FOUND - Referenced item doesn't exist

              - 4: VALIDATION - Spec validation failed

              - 5: CONFLICT - Item already exists, duplicate slug, etc.


              **New additions to consider:**

              - 6: PARTIAL - Some operations succeeded, some failed (for batch operations)


              **Documentation format:** Add to 'kspec help' or new 'kspec help --exit-codes'
              subcommand showing all codes with descriptions.
            supersedes: null
      - _ulid: 01KEZCJPHWBEEP2BYRP6YVNK9F
        slugs:
          - cli-agent-features
        title: Agent-Friendly Features
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Features for agent/script usage:

          - --json: Structured output
          - --no-prompt: Never prompt (KSPEC_NO_PROMPT=1)
          - --dry-run: Show what would happen
          - --if-not-exists: Idempotent creation
          - --quiet: Suppress non-essential output

          Agents should be able to use kspec without interaction.
        implements:
          - "@cli-design"
      - _ulid: 01KFHZSJVGEX3KTM5CHM8J1XAN
        slugs:
          - cli-version
        title: CLI Version Display
        type: requirement
        tags: []
        description: The CLI must display the correct version from package.json when running 'kspec
          --version' or 'kspec -V'. Version must stay in sync with the npm package version.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-22T04:35:53.841Z
        acceptance_criteria:
          - id: ac-1
            given: kspec is installed from npm
            when: user runs 'kspec --version' or 'kspec -V'
            then: displays the version from package.json (e.g., '0.1.1')
          - id: ac-2
            given: a new version is released
            when: package.json version is updated
            then: CLI --version output automatically reflects the new version without code changes
          - id: ac-3
            given: kspec is run in development via 'npm run dev'
            when: user runs 'npm run dev -- --version'
            then: displays the same version as package.json
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KEZCJPHXV1SK9BY02J6GK719
    slugs:
      - item-commands
    title: Item Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      CRUD operations for spec items.
      The foundation of CLI functionality.
    acceptance_criteria:
      - id: ac-item-cmd-1
        given: valid item data
        when: kspec item add runs
        then: item is created with auto-generated ULID
      - id: ac-item-cmd-2
        given: an existing item @login
        when: kspec item get @login runs
        then: full item data is displayed
    requirements:
      - _ulid: 01KEZCJPHXGMME0BZ5C65R5QH8
        slugs:
          - item-add
        title: kspec item add
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec item add [options]

          Options:
          - --type <type>: Item type (feature, requirement, etc.)
          - --title <title>: Required title
          - --slug <slug>: Optional slug (auto-generated if not provided)
          - --field key=value: Set additional fields
          - --parent <ref>: Nest under parent item

          Returns created item (with generated ULID).
        implements:
          - "@item-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KEZCJPHXKYVVP0YWF261A8N3
        slugs:
          - item-get
        title: kspec item get
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec item get <ref> [options]

          Options:
          - --field <path>: Get specific field only
          - --format <fmt>: Output format (yaml, json)

          Resolves @reference, displays full item.
        implements:
          - "@item-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
        acceptance_criteria:
          - id: ac-1
            given: a spec item @login has acceptance criteria
            when: kspec item get @login runs
            then: acceptance criteria are displayed in the output
          - id: ac-2
            given: a valid reference @login exists
            when: kspec item get @login runs
            then: displays item title, ULID, slugs, type, status, and description
          - id: ac-3
            given: reference @nonexistent does not exist
            when: kspec item get @nonexistent runs
            then: exits with error and helpful message
      - _ulid: 01KEZCJPHXT212CZV6W64YJFAQ
        slugs:
          - item-list
        title: kspec item list
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec item list [filters]

          Filters:
          - --type <type>: By item type
          - --status <status>: By maturity/implementation
          - --tag <tag>: By tag
          - --has-field <field>: Items with field present

          Returns list of matching items.
        implements:
          - "@item-commands"
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KEZCJPHX678F01J6TZE5SX1Q
        slugs:
          - item-set
        title: kspec item set
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |-
          kspec item set <ref> [options]

          Update a spec item's fields.

          Options:
          - --title <title>: Set item title
          - --type <type>: Set item type
          - --slug <slug>: Add a slug (can have multiple)
          - --remove-slug <slug>: Remove a slug
          - --priority <priority>: Set priority
          - --tag <tag...>: Set tags (replaces existing)
          - --description <desc>: Set description
          - --status <status>: Set implementation status
          - --maturity <maturity>: Set maturity level

          Updates item in place and auto-commits to shadow branch.
        implements:
          - "@item-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
        acceptance_criteria:
          - id: ac-1
            given: item @my-item exists with slugs ['original']
            when: kspec item set @my-item --slug new-slug runs
            then: item now has slugs ['original', 'new-slug']
          - id: ac-2
            given: item @my-item exists with slugs ['keep', 'remove']
            when: kspec item set @my-item --remove-slug remove runs
            then: item now has slugs ['keep']
          - id: ac-3
            given: item @my-item has only one slug 'only-one'
            when: kspec item set @my-item --remove-slug only-one runs
            then: "error: cannot remove last slug"
          - id: ac-4
            given: item @my-item exists
            when: kspec item set @my-item --status implemented runs
            then: item's implementation status is updated to 'implemented'
      - _ulid: 01KEZCJPHXH5SAZ7NWESVKWS3Y
        slugs:
          - item-delete
        title: kspec item delete
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec item delete <ref> [options]

          Options:
          - --force: Skip confirmation
          - --cascade: Delete children too

          Warns if item has references. Consider deprecation instead.
        implements:
          - "@item-commands"
        traits:
          - "@trait-json-output"
          - "@trait-confirmation-prompt"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF374D6206HGMP55HGE8VNAQ
        slugs:
          - item-ac
        title: kspec item ac
        type: requirement
        tags: []
        description: |-
          kspec item ac <subcommand>

          Subcommands:
          - add <ref> --given '...' --when '...' --then '...': Add acceptance criterion
          - list <ref>: List acceptance criteria for an item
          - set <ref> <ac-id> [options]: Update an acceptance criterion
          - remove <ref> <ac-id> [--force]: Remove an acceptance criterion

          Manages acceptance criteria on spec items via CLI.
          Handles proper YAML escaping to prevent formatting errors.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        acceptance_criteria:
          - id: ac-item-ac-add
            given: a spec item exists
            when: kspec item ac add @ref --given "precondition" --when "action" --then "outcome" runs
            then: 'AC is added with auto-generated ID; outputs "OK Added acceptance criterion: ac-N to @ref"'
          - id: ac-item-ac-add-id
            given: a spec item exists
            when: kspec item ac add @ref --id custom-id --given "..." --when "..." --then "..." runs
            then: AC is added with the specified ID
          - id: ac-item-ac-add-dup
            given: a spec item with AC id "ac-1" exists
            when: kspec item ac add @ref --id ac-1 --given "..." --when "..." --then "..." runs
            then: exits code 3; error "Acceptance criterion ac-1 already exists"
          - id: ac-item-ac-add-task
            given: a task exists (not a spec item)
            when: kspec item ac add @task-ref --given "..." --when "..." --then "..." runs
            then: exits code 3; error "Tasks don't have acceptance criteria"
          - id: ac-item-ac-list
            given: a spec item with acceptance criteria
            when: kspec item ac list @ref runs
            then: displays all AC in Given/When/Then format with IDs
          - id: ac-item-ac-list-empty
            given: a spec item without acceptance criteria
            when: kspec item ac list @ref runs
            then: displays "No acceptance criteria"
          - id: ac-item-ac-set
            given: a spec item with AC id "ac-1"
            when: kspec item ac set @ref ac-1 --then "new outcome" runs
            then: 'AC then field is updated; outputs "OK Updated acceptance criterion: ac-1 on @ref (then)"'
          - id: ac-item-ac-set-notfound
            given: a spec item without AC id "ac-99"
            when: kspec item ac set @ref ac-99 --then "..." runs
            then: exits code 3; error "Acceptance criterion ac-99 not found"
          - id: ac-item-ac-remove
            given: a spec item with AC id "ac-1"
            when: kspec item ac remove @ref ac-1 --force runs
            then: 'AC is removed; outputs "OK Removed acceptance criterion: ac-1 from @ref"'
          - id: ac-item-ac-remove-confirm
            given: a spec item with AC id "ac-1"
            when: kspec item ac remove @ref ac-1 runs (no --force)
            then: prompts for confirmation before removing
        created: 2026-01-16T10:55:32.034Z
        status:
          maturity: draft
          implementation: implemented
      - _ulid: 01KF3E3QPARGX5QWJMT231DCC5
        slugs:
          - item-patch
        title: kspec item patch
        type: requirement
        tags:
          - cli
          - dx
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T12:57:30.058Z
        description: |-
          kspec item patch <ref> [options]

          Update spec item with JSON data.

          Options:
          - --data <json>: JSON object with fields to update
          - --bulk: Read multiple patches from stdin (JSONL or JSON array)
          - --fail-fast: Stop on first error in bulk mode (default: continue)
          - --dry-run: Show what would change without writing
          - --allow-unknown: Allow unknown fields (for extending format)

          Single item mode:
            kspec item patch @my-item --data '{"title": "New"}'
            echo '{"title": "New"}' | kspec item patch @my-item

          Bulk mode (JSONL or JSON array on stdin):
            cat patches.jsonl | kspec item patch --bulk
            echo '[{"ref":"@a","data":{...}}]' | kspec item patch --bulk

          Validates input against SpecItemInputSchema (strict by default).
        acceptance_criteria:
          - id: ac-1
            given: valid JSON with status field
            when: kspec item patch @my-item --data '{"status":{"implementation":"implemented"}}' runs
            then: item status is updated to implemented
          - id: ac-2
            given: invalid JSON syntax
            when: kspec item patch @my-item --data 'not json' runs
            then: error with helpful JSON parse message
          - id: ac-3
            given: JSON piped via stdin
            when: echo '{"title":"New"}' | kspec item patch @my-item runs
            then: stdin JSON is used for update
          - id: ac-4
            given: --dry-run flag provided
            when: kspec item patch @my-item --data '{"title":"New"}' --dry-run runs
            then: shows what would change without writing
          - id: ac-5
            given: JSON with unknown field 'foobar'
            when: kspec item patch @my-item --data '{"foobar":"value"}' runs
            then: error about unknown field
          - id: ac-6
            given: JSON with unknown field and --allow-unknown flag
            when: kspec item patch @my-item --data '{"foobar":"value"}' --allow-unknown runs
            then: field is written to item
          - id: ac-7
            given: JSONL with multiple patches on stdin
            when: cat patches.jsonl | kspec item patch --bulk runs
            then: all items updated, summary shown
          - id: ac-8
            given: JSON array with multiple patches on stdin
            when: echo '[{"ref":"@a","data":{...}}]' | kspec item patch --bulk runs
            then: all items updated, summary shown
          - id: ac-9
            given: bulk mode with one invalid ref among valid
            when: command runs without --fail-fast
            then: valid items updated, errors reported, exit 1
          - id: ac-10
            given: bulk mode with --fail-fast and first ref invalid
            when: command runs
            then: stops immediately, no items updated, exit 1
          - id: ac-11
            given: ref points to a task (not spec item)
            when: kspec item patch @some-task --data '{...}' runs
            then: "error: Not a spec item"
          - id: ac-12
            given: ref does not exist
            when: kspec item patch @nonexistent --data '{...}' runs
            then: "error: Item not found: @nonexistent"
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01JHNKA8W6CTSK000000000000
    slugs:
      - task-commands
    title: Task Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      Commands for task lifecycle management.
      State transitions, queries, notes, todos.
    requirements:
      - _ulid: 01JHNKA8W7CTSK100000000000
        slugs:
          - task-add
        title: kspec task add
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task add [options]

          Options:
          - --title <title>: Task title
          - --type <type>: task, epic, bug, spike, infra
          - --spec-ref <ref>: Link to spec item
          - --depends-on <refs>: Dependencies
          - --priority <n>: Priority (1-5)

          Creates task in pending status.
        implements:
          - "@task-commands"
      - _ulid: 01JHNKA8W8CTSK200000000000
        slugs:
          - task-start
        title: kspec task start
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task start <ref>

          Transitions task from pending to in_progress.
          Sets started_at timestamp.
          Fails if task is blocked or already in_progress.
        implements:
          - "@task-commands"
        depends_on:
          - "@state-in-progress"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA8W9CTSK300000000000
        slugs:
          - task-complete
        title: kspec task complete
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task complete <ref> [options]

          Options:
          - --reason <text>: Completion note

          Transitions task to completed status.
          Sets completed_at timestamp.
        implements:
          - "@task-commands"
        depends_on:
          - "@state-completed"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
          - "@trait-multi-ref-batch"
      - _ulid: 01KFDZYWG0CTSK250000000000
        slugs:
          - task-submit
          - cmd-task-submit
        title: kspec task submit
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task submit <ref>

          Transitions task from in_progress to pending_review.
          Indicates code is complete and ready for review/merge.
        implements:
          - "@task-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA9W0CTSK400000000000
        slugs:
          - task-block
        title: kspec task block
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task block <ref> [options]

          Options:
          - --reason <text>: Required blocker description

          Transitions task to blocked status.
          Adds reason to blocked_by array.
        implements:
          - "@task-commands"
        depends_on:
          - "@state-blocked"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA9W1CTSK500000000000
        slugs:
          - task-unblock
        title: kspec task unblock
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task unblock <ref>

          Transitions task from blocked back to in_progress (or pending).
          Clears blocked_by array.
        implements:
          - "@task-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA9W2CTSK600000000000
        slugs:
          - task-cancel
        title: kspec task cancel
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task cancel <ref> [options]

          Options:
          - --reason <text>: Why cancelled

          Transitions task to cancelled status.
          Terminal state.
        implements:
          - "@task-commands"
        depends_on:
          - "@state-cancelled"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
          - "@trait-multi-ref-batch"
      - _ulid: 01KF0VJEHSCEQ5SVD6XRYV81M1
        slugs:
          - cmd-task-delete
        title: kspec task delete
        type: requirement
        tags: []
        description: |-
          kspec task delete <ref> [options]

          Options:
          - --force: Skip confirmation
          - --dry-run: Show what would be deleted

          Removes task from source file. Confirmation required unless --force.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-15T12:55:00.409Z
        status:
          maturity: draft
          implementation: implemented
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
          - "@trait-multi-ref-batch"
          - "@trait-confirmation-prompt"
        acceptance_criteria:
          - id: ac-1
            given: A task exists with ref @test-task
            when: kspec task delete @test-task --dry-run
            then: Shows 'Would delete task:' with task title and source file, without actually deleting
          - id: ac-2
            given: A task exists with ref @test-task
            when: kspec task delete @test-task --force
            then: Task is removed from source file and success message shows deleted task title
      - _ulid: 01KF24HMZXS5XZM7K109MRMEP3
        slugs:
          - task-set
        title: kspec task set
        type: requirement
        tags: []
        description: |-
          kspec task set <ref> [options]

          Options:
          - --title <title>: Update task title
          - --spec-ref <ref>: Link to spec item
          - --depends-on <refs>: Set dependencies (replaces existing)
          - --priority <n>: Set priority (1-5)
          - --slug <slug>: Add a slug alias
          - --tag <tag>: Add a tag (repeatable)

          Modifies task fields without changing state.
          Use for linking tasks to specs, adjusting priority, etc.
        acceptance_criteria:
          - id: ac-task-set-1
            given: a task exists
            when: kspec task set @task --title 'New Title' runs
            then: 'task title is updated; outputs "OK Updated task: <ref> (title)"'
          - id: ac-task-set-2
            given: a task and spec item exist
            when: kspec task set @task --spec-ref @spec-item runs
            then: task spec_ref is set; outputs confirmation with (spec_ref)
          - id: ac-task-set-3
            given: a task exists
            when: kspec task set @task --spec-ref @nonexistent runs
            then: exits code 3; error "Spec reference not found"
          - id: ac-task-set-4
            given: two tasks exist
            when: kspec task set @task1 --spec-ref @task2 runs
            then: exits code 3; error "is a task, not a spec item"
          - id: ac-task-set-5
            given: a task exists
            when: kspec task set @task --priority 3 runs
            then: task priority is updated to 3
          - id: ac-task-set-6
            given: a task exists
            when: kspec task set @task --priority 6 runs
            then: exits code 3; error "Priority must be between 1 and 5"
          - id: ac-task-set-7
            given: a task exists
            when: kspec task set @task runs with no options
            then: warns "No changes specified"; no changes saved
          - id: ac-author
            given: note is auto-generated by --clear-deps or --automation
            when: operation completes
            then: note author is set via getAuthor() (KSPEC_AUTHOR env var, or git user fallback)
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:05.853Z
        status:
          maturity: draft
          implementation: implemented
      - _ulid: 01KF24J220BKK8X3QA86N59E4X
        slugs:
          - task-get
        title: kspec task get
        type: requirement
        tags: []
        description: |-
          kspec task get <ref>

          Displays task details including:
          - Status and timestamps
          - Spec reference if linked
          - Dependencies and blockers
          - Recent notes summary

          Primary command for inspecting individual tasks.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:19.234Z
        status:
          implementation: implemented
      - _ulid: 01KF24J46CY5Y7MPN1PXZT2GRB
        slugs:
          - task-note
        title: kspec task note
        type: requirement
        tags: []
        description: |-
          kspec task note <ref> <message>

          Options:
          - --author <ref>: Note author (default: @claude or @user)

          Appends a timestamped note to the task's notes array.
          Notes are append-only and track work progress.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:21.422Z
        status:
          implementation: implemented
      - _ulid: 01KF24J6HENWZ8KS5ZHQHCMA9B
        slugs:
          - task-notes-cmd
        title: kspec task notes
        type: requirement
        tags: []
        description: |-
          kspec task notes <ref>

          Displays all notes for a task in chronological order.
          Shows timestamp, author, and content for each note.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:23.823Z
        status:
          implementation: implemented
      - _ulid: 01KF24J8KKT3Y1N6M6JR7ACHQ8
        slugs:
          - task-todos-cmd
        title: kspec task todos
        type: requirement
        tags: []
        description: |-
          kspec task todos <ref>

          Displays all todos for a task.
          Shows status (pending/done), text, and completion info.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:25.939Z
        status:
          implementation: implemented
      - _ulid: 01KF24JAEM65BGJ5ZK0QM4XQNN
        slugs:
          - task-todo
        title: kspec task todo
        type: requirement
        tags: []
        description: |-
          kspec task todo <subcommand>

          Subcommands:
          - add <ref> <text>: Add a todo to a task
          - done <ref> <index>: Mark a todo as done
          - remove <ref> <index>: Remove a todo

          Lightweight checklist items within a task.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T00:51:27.829Z
        status:
          implementation: implemented
      - _ulid: 01KF3E3S2Y8PZ1E75G202DG2JR
        slugs:
          - task-patch
        title: kspec task patch
        type: requirement
        tags:
          - cli
          - dx
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T12:57:31.487Z
        description: |-
          kspec task patch <ref> [options]

          Update task with JSON data.

          Options:
          - --data <json>: JSON object with fields to update
          - --dry-run: Show what would change without writing
          - --allow-unknown: Allow unknown fields (for extending format)

          Accepts stdin if no --data provided.
          Validates input against TaskInputSchema (strict by default).
        acceptance_criteria:
          - id: ac-1
            given: valid JSON with priority field
            when: kspec task patch @my-task --data '{"priority":1}' runs
            then: task priority is updated
          - id: ac-2
            given: invalid JSON syntax
            when: kspec task patch @my-task --data 'bad' runs
            then: error with helpful message
          - id: ac-3
            given: JSON with unknown field
            when: kspec task patch @my-task --data '{"unknown":true}' runs
            then: error about unknown field (strict by default)
          - id: ac-4
            given: --allow-unknown flag and unknown field
            when: kspec task patch @my-task --data '{"unknown":true}' --allow-unknown runs
            then: field is written
        status:
          maturity: draft
          implementation: implemented
    features:
      - _ulid: 01KF41VNTAWFBTPPNAWJFFD6T6
        slugs:
          - commit-guidance
        title: Commit Message Guidance
        type: feature
        tags:
          - process
          - traceability
        description: >-
          Outputs suggested commit messages with standardized trailers after completing tasks or
          during session checkpoint. Reinforces trailer convention for traceability and enables
          kspec log searches.


          Trailer format:

          - Task: @task-slug (always present)

          - Spec: @spec-ref (if task.spec_ref exists)


          When no spec_ref: prompts agent to consider if spec coverage is needed.


          Output triggers:

          - task complete: Full commit message suggestion

          - session checkpoint: WIP commit guidance when task in_progress with uncommitted changes
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T18:42:37.515Z
        acceptance_criteria:
          - id: ac-1
            given: task has spec_ref
            when: task complete runs
            then: "output includes both Task: and Spec: trailers"
          - id: ac-2
            given: task has no spec_ref
            when: task complete runs
            then: "output includes Task: trailer and warning about potential spec gap"
          - id: ac-3
            given: task in_progress with uncommitted changes
            when: session checkpoint runs
            then: WIP commit guidance included in instructions
          - id: ac-4
            given: JSON mode enabled
            when: commit guidance would be shown
            then: guidance is suppressed (JSON output only)
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01JHNKA9W3CQRY000000000000
    slugs:
      - query-commands
    title: Query Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      Commands for querying spec and task data.
      The primary interface for understanding what exists and what's ready.
    requirements:
      - _ulid: 01JHNKA9W4CQRY100000000000
        slugs:
          - cmd-tasks-ready
        title: kspec tasks ready
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec tasks ready [options]

          Returns all tasks that are ready to work on:
          - status = pending
          - all depends_on completed
          - no blocked_by entries

          THE primary command for agents and humans.
        implements:
          - "@query-commands"
          - "@query-ready"
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA9W5CQRY200000000000
        slugs:
          - cmd-tasks-next
        title: kspec tasks next
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec tasks next

          Returns single highest-priority ready task.
          Useful for "give me something to do" workflow.
        implements:
          - "@query-commands"
          - "@query-next"
      - _ulid: 01JHNKA9W6CQRY300000000000
        slugs:
          - cmd-tasks-list
        title: kspec tasks list
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec tasks list [filters]

          General task listing with filters.
          See @query-filters for filter options.
        implements:
          - "@query-commands"
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01JHNKA9W7CQRY400000000000
        slugs:
          - cmd-tasks-blocked
        title: kspec tasks blocked
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec tasks blocked

          Returns all blocked tasks with their blockers.
          Useful for identifying what's stuck.
        implements:
          - "@query-commands"
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF41T5PN7Z6K6SXQK2S8K6DH
        slugs:
          - cmd-log
        title: kspec log
        type: requirement
        tags: []
        description: >-
          kspec log [ref]


          Search git history for commits referencing spec items or tasks. Wraps git log --grep to
          search for trailer patterns (Task: @ref, Spec: @ref).


          Options:

          - <ref>: Task or spec reference to search for

          - --spec <ref>: Search for Spec: trailer specifically

          - --task <ref>: Search for Task: trailer specifically

          - -n, --limit <n>: Limit results (default: 10)

          - --oneline: Compact output format

          - --since <time>: Only commits after date


          Examples:

          - kspec log @my-task        # Commits for task

          - kspec log --spec @auth    # Commits for spec item

          - kspec log @task --oneline # Compact format
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T18:41:48.245Z
        acceptance_criteria:
          - id: ac-1
            given: "commits exist with Task: @my-task trailer"
            when: kspec log @my-task runs
            then: matching commits are displayed
          - id: ac-2
            given: reference is a spec item
            when: kspec log @spec-item runs
            then: "searches for both Spec: trailer and Task: trailers of linked tasks"
          - id: ac-3
            given: no matching commits exist
            when: kspec log @ref runs
            then: displays 'No commits found' message
          - id: ac-4
            given: --oneline flag provided
            when: kspec log @ref --oneline runs
            then: shows compact hash + subject format
          - id: ac-5
            given: reference doesn't exist
            when: kspec log @invalid runs
            then: shows error 'Reference not found' with exit code 3
          - id: list-all-tracked
            given: No ref argument provided
            when: User runs kspec log without any ref or filter
            then: "Shows all commits with Task: or Spec: trailers in reverse chronological order, respecting
              --limit (default 10)"
          - id: passthrough-args
            given: User wants additional git log formatting (like -p, --stat, --graph)
            when: User runs kspec log @ref -- -p --stat
            then: Arguments after -- are passed through to underlying git log command
          - id: passthrough-invalid
            given: User passes invalid git log arguments after --
            when: User runs kspec log @ref -- --invalid-flag
            then: Git's error message is shown and command exits with non-zero code
        status:
          maturity: draft
          implementation: implemented
        notes:
          - _ulid: 01KFACYYRM33Z9W1PW01ASMWTZ
            created_at: 2026-01-19T05:52:05.909Z
            author: "@claude"
            content: >-
              Enhancement: List all tracked commits and git log passthrough


              **New features (ACs list-all-tracked, passthrough-args, passthrough-invalid):**


              1. **List all tracked commits without ref:**
                 Running `kspec log` without any ref should show all commits that have Task: or Spec: trailers. This gives visibility into all tracked work across the repo.
                 Implementation: Use git log --grep pattern that matches either trailer:
                 git log --grep='Task: @' --grep='Spec: @' --all-match=false
                 Respects existing --limit flag (default 10).

              2. **Passthrough git log args:**
                 Allow passing additional git log flags after -- separator:
                 `kspec log @ref -- -p --stat --graph`
                 This enables power users to get diffs (-p), stats (--stat), or other git log formatting without kspec needing to wrap every possible option.
                 Implementation: Detect -- in argv, split args, pass remainder to git log.
                 Commander.js supports -- passthrough via .passThroughOptions() or manual argv handling.

              **Backward compatibility:** Existing usage unchanged. New features are additive.
            supersedes: null
      - _ulid: 01KF4NDCHV22PNBV13QS9J5SHB
        slugs:
          - task-list-verbose
        title: Enhanced Verbose Output for Task Lists
        type: requirement
        tags: []
        description: >-
          Task list commands (ready, list, blocked, in-progress) support enhanced verbose output
          showing richer context beyond the default one-line summary.


          Default output: ULID, slug, status, priority, title, first line of description

          Verbose (-v): Adds spec_ref, depends_on, tags (current behavior)

          Full (--full or -vv): Adds notes count, recent note preview, todos pending, timestamps,
          complexity


          This helps agents and humans quickly assess task context without running task get on each
          item.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-17T00:24:20.795Z
        acceptance_criteria:
          - id: ac-1
            given: A user runs tasks ready/list/blocked/in-progress with --full or -vv
            when: Tasks are displayed
            then: "Each task shows: notes count, most recent note (first 50 chars), pending todos count,
              created_at timestamp"
          - id: ac-2
            given: A user runs tasks ready with -v (single verbose)
            when: Tasks are displayed
            then: "Current behavior preserved: shows spec_ref, depends_on, tags inline"
          - id: ac-3
            given: A task has no notes or todos
            when: Displayed in full mode
            then: Notes and todos sections are omitted or show 0, not errors
          - id: ac-4
            given: A user runs tasks list --full --json
            when: Output is generated
            then: JSON includes all verbose fields (notes array, todos array, timestamps)
          - id: ac-5
            given: A task has a spec_ref linking to a spec item
            when: Displayed in full mode (--full or -vv)
            then: Shows the linked spec's description and acceptance criteria inline, similar to task get output
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KEZCJPHX1XC0F94K2HJ2F99X
    slugs:
      - link-commands
    title: Link Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: medium
    tags:
      - cli
    description: |
      Commands for managing relationships between items.
      Create, query, and remove links.
    requirements:
      - _ulid: 01KEZCJPHXWK4N7K72F0CFWBGN
        slugs:
          - link-create
        title: kspec link create
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec link create <from> <to> [options]

          Options:
          - --type <type>: Relationship type (depends_on, implements, etc.)

          Creates relationship from source to target.
          Updates the source item's relationship array.
        implements:
          - "@link-commands"
      - _ulid: 01KEZCJPHY64RH5PPE6WJSPH03
        slugs:
          - link-list
        title: kspec link list
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec link list [options]

          Options:
          - --from <ref>: Links from this item
          - --to <ref>: Links to this item
          - --type <type>: Filter by relationship type

          Shows relationships matching filters.
        implements:
          - "@link-commands"
      - _ulid: 01KEZCJPHYBD2BSED0D9ZHRMGQ
        slugs:
          - link-delete
        title: kspec link delete
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec link delete <from> <to> [options]

          Options:
          - --type <type>: Specific relationship type to remove

          Removes relationship. Updates source item.
        implements:
          - "@link-commands"
  - _ulid: 01KEZCJPHYBMBBKESVKBBV4CGM
    slugs:
      - validate-commands
    title: Validation Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      Commands for validating spec and task integrity.
      Essential for CI and pre-commit checks.
    requirements:
      - _ulid: 01KEZCJPHYHN29QV8C088GVGD1
        slugs:
          - cmd-validate
        title: kspec validate
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |-
          kspec validate [options]

          Options:
          - --schema: Check schema conformance only
          - --refs: Check all @references resolve
          - --orphans: Find unreferenced items
          - --task-refs: Check task spec_refs resolve
          - --fix: Auto-fix issues where possible (invalid ULIDs, missing timestamps)
          - --strict: Treat warnings as errors

          Default: All checks. Returns errors and warnings.

          Auto-fix behavior (--fix):
          - Invalid ULIDs: Regenerates with valid ULID
          - Missing timestamps: Adds created field if neither created nor created_at exists
          - Excludes test fixtures from auto-fixing
          - Re-validates after fixes to confirm resolution
        implements:
          - "@validate-commands"
          - "@validation-modes"
      - _ulid: 01KEZCJPHYVBG79TSAVC1KB0SZ
        slugs:
          - cmd-lint
        title: kspec lint
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec lint [options]

          Options:
          - --fix: Auto-fix what's possible
          - --strict: Exit non-zero on warnings

          Combines validation with style checks.
          Good for CI: kspec lint --strict
        implements:
          - "@validate-commands"
      - _ulid: 01KFADE3F4XFXX4E0WTFYZ839W
        slugs:
          - stale-status-detection
        title: Stale status detection
        type: requirement
        tags:
          - validation
          - dx
        description: Detect and warn about status inconsistencies between specs, tasks, and implementation.
          Helps maintain alignment between what's documented and what's actually done.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        notes:
          - _ulid: 01KFADF5PMS0ECF20AAX4SRAZ2
            created_at: 2026-01-19T06:00:57.301Z
            author: "@claude"
            content: >-
              Design: Stale status detection


              **Problem:** Spec-task alignment can drift over time. A parent task may stay pending
              while all children are done. A spec may be marked implemented without any task
              tracking the work. These inconsistencies reduce trust in the system.


              **Solution:** Add --staleness flag to validate command that checks for status
              mismatches.


              **Detection rules:**


              1. **Parent pending, children done:**
                 - Find tasks that are pending/in_progress
                 - Check if they have spec_ref to a parent item
                 - Check if all child specs under that parent are implemented
                 - If so, warn about the parent task

              2. **Spec implemented, no task:**
                 - Find specs with implementation_status = implemented
                 - Check if any completed tasks have spec_ref pointing to it
                 - If none, warn about orphaned implementation

              3. **Task done, spec not started:**
                 - Find completed tasks with spec_ref
                 - Check the linked spec's implementation_status
                 - If not_started, warn about the mismatch

              **Output format:**

              ```

              Staleness warnings (3):
                ⚠ Task @parent-task is pending but all linked specs are implemented
                ⚠ Spec @orphan-spec is implemented but has no completed tasks
                ⚠ Task @done-task completed but spec @stale-spec is not_started
              ```


              **Flags:**

              - --staleness: Enable staleness checks

              - --strict: Treat warnings as errors (exit 4)
            supersedes: null
        created: 2026-01-19T06:00:22.244Z
        acceptance_criteria:
          - id: parent-pending-children-done
            given: Task with dependency tasks, where task status is pending or in_progress
            when: kspec validate --staleness runs and all dependency tasks are completed
            then: "Warns: 'Task @task is pending/in_progress but all dependencies are completed. Consider
              completing or reviewing.'"
          - id: spec-implemented-no-task
            given: Spec item is marked implemented but no completed tasks reference it
            when: kspec validate --staleness runs
            then: "Warns: 'Spec @spec-item is implemented but has no completed tasks. Verify implementation or
              link existing task.'"
          - id: task-done-spec-not-started
            given: Task is completed but linked spec is still not_started
            when: kspec validate --staleness runs
            then: "Warns: 'Task @task completed but spec @spec-item is not_started. Update spec status.'"
          - id: staleness-flag
            given: User wants to check for stale statuses
            when: kspec validate --staleness runs
            then: Performs staleness checks in addition to standard validation. Can be combined with other
              validate flags.
          - id: staleness-exit-code
            given: Staleness issues are found
            when: kspec validate --staleness completes
            then: Exits with code 0 (warnings don't fail validation by default). With --strict, exits code 4 if
              any staleness warnings.
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01JHNKAA05CDRV000000000000
    slugs:
      - derive-commands
    title: Derive Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      Commands for deriving tasks from spec items.
      Explicit, on-demand task creation.
    requirements:
      - _ulid: 01JHNKAA06CDRV100000000000
        slugs:
          - cmd-derive
        title: kspec derive
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec derive <ref> [options]
          kspec derive --all [options]

          Derives implementation tasks from spec items.

          Behavior:
          - Recursively creates tasks for item and all children
          - Features create feature tasks
          - Requirements create requirement tasks under feature
          - Auto-sets depends_on based on spec hierarchy:
            - Requirement tasks depend on parent feature task
            - Child features depend on parent module task
          - Skips items that already have tasks (unless --force)

          Options:
          - --recursive: Derive for item and all children (default)
          - --flat: Only derive for the specified item, no children
          - --force: Create even if task exists
          - --dry-run: Show what would be created
          - --json: Output created tasks as JSON

          Examples:
            kspec derive @shadow-branch
            # Creates tasks for module + all features + all requirements
            # with proper depends_on relationships

            kspec derive @shadow-concept --flat
            # Creates single task for just that feature

          Idempotent by default.
        implements:
          - "@derive-commands"
          - "@derive-command"
        acceptance_criteria:
          - id: ac-1
            given: a spec item with no children
            when: kspec derive @item runs
            then: "creates one task with spec_ref=@item; outputs 'Created task: <ref>'"
          - id: ac-2
            given: a module with 2 child features
            when: kspec derive @module runs
            then: creates 3 tasks (module + 2 features); each task has correct spec_ref
          - id: ac-3
            given: a module with child features
            when: kspec derive @module --flat runs
            then: creates 1 task for module only; children are not processed
          - id: ac-4
            given: a feature under a module
            when: derive creates tasks for both
            then: feature task has depends_on containing module task ref
          - id: ac-5
            given: a requirement under a feature
            when: derive creates tasks for both
            then: requirement task has depends_on containing feature task ref
          - id: ac-6
            given: module task already exists, feature has no task
            when: kspec derive @feature runs
            then: feature task depends_on references existing module task
          - id: ac-7
            given: a spec item already has a linked task
            when: kspec derive @item runs (no --force)
            then: "no task created; outputs 'Skipped @item (task exists: @task-ref)'"
          - id: ac-8
            given: module has task, feature-a has task, feature-b has no task
            when: kspec derive @module runs
            then: only feature-b task created; module and feature-a skipped with message
          - id: ac-9
            given: a spec item already has a linked task
            when: kspec derive @item --force runs
            then: new task created; outputs warning 'Created duplicate task for @item'
          - id: ac-10
            given: a module with children
            when: kspec derive @module --dry-run runs
            then: outputs 'Would create:' followed by task list; no tasks actually created; exit 0
          - id: ac-11
            given: derive creates tasks
            when: --json flag is passed
            then: "outputs JSON array with objects {ulid, slug, spec_ref, depends_on, action:
              'created'|'skipped'}"
          - id: ac-12
            given: 3 spec items exist, 1 already has a task
            when: kspec derive --all runs
            then: creates tasks for 2 items without tasks; skips the one with existing task
          - id: ac-13
            given: "@nonexistent does not resolve"
            when: kspec derive @nonexistent runs
            then: "exits code 1; error 'Reference not found: @nonexistent'"
          - id: ac-14
            given: all spec items already have tasks
            when: kspec derive --all runs
            then: outputs 'Nothing to derive (all items have tasks)'; exit 0
          - id: ac-author
            given: note is auto-generated from spec description
            when: task created with implementation notes
            then: note author is set via getAuthor() (KSPEC_AUTHOR env var, or git user fallback)
          - id: ac-15
            given: parent spec has task in cancelled state
            when: derive creates child task with depends_on
            then: cancelled parent task is excluded from depends_on; only active/completed tasks used
  - _ulid: 01KEZCJPHYV1GH5KP8T0VSXWWS
    slugs:
      - init-commands
    title: Init and Config Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - cli
    description: |
      Commands for initializing and configuring kspec.
      Project setup and configuration management.
    requirements:
      - _ulid: 01KEZCJPHYDTPQ34W8FRXQ9GKX
        slugs:
          - cmd-init
        title: kspec init
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec init [options]

          Options:
          - --name <name>: Project name
          - --single-file: Create kynetic.yaml only (vs directory)

          Creates initial spec structure:
          - spec/kynetic.yaml (manifest)
          - spec/modules/ (if not --single-file)

          Interactive prompts unless --no-prompt.
        implements:
          - "@init-commands"
      - _ulid: 01KEZCJPHYZKAW6006AM7P5KWT
        slugs:
          - cmd-hooks
        title: kspec hooks
        type: requirement
        status:
          maturity: draft
          implementation: not_started
        description: |
          kspec hooks install     # Install configured hooks
          kspec hooks uninstall   # Remove hooks
          kspec hooks list        # Show configured hooks

          Reads hooks from manifest config section.
          Sets up git hooks for validation.
        implements:
          - "@init-commands"
      - _ulid: 01KF14PTK6XWQPE0ZG32WMVJRK
        slugs:
          - cmd-setup
        title: kspec setup
        type: requirement
        tags:
          - mvp
          - cli
        description: >-
          kspec setup [options]


          Configures agent environment for kspec. Auto-detects the running agent and installs
          appropriate configuration.


          Agent Detection:

          - claude-code (via CLAUDECODE, CLAUDE_CODE_ENTRYPOINT, etc.)

          - aider (via AIDER_* env vars)

          - cline/roo-code (VS Code extensions)

          - copilot-cli, gemini-cli, codex-cli, opencode, amp


          Actions:

          - Sets KSPEC_AUTHOR in agent config file (e.g., ~/.claude/settings.json)

          - For Claude Code: installs hooks to .claude/settings.json (project-level):
            - UserPromptSubmit: spec-first reminder (session prompt-check)
            - Stop: session checkpoint for uncommitted work
          - Prints manual instructions for agents without config file support


          Options:

          - --dry-run: Show what would be done without making changes

          - --author <author>: Custom author string (default: auto-detected like @claude, @aider)

          - --no-hooks: Skip installing Claude Code hooks

          - --force: Overwrite existing configuration


          Exit codes follow @cli-exit-codes.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-15T15:34:40.999Z
        status:
          maturity: draft
          implementation: implemented
        acceptance_criteria:
          - id: detect-existing-repo
            given: Repository has kspec-meta branch but no .kspec worktree
            when: User runs kspec setup or any kspec command
            then: "Detects missing worktree and prompts: 'kspec-meta branch exists but .kspec worktree is
              missing. Create it? (y/N)', creates worktree if confirmed"
          - id: auto-worktree-flag
            given: Repository has kspec-meta branch but no .kspec worktree
            when: User runs kspec setup --auto-worktree
            then: Automatically creates .kspec worktree without prompting
          - id: worktree-already-exists
            given: .kspec worktree already exists and is valid
            when: User runs kspec setup
            then: Skips worktree creation, proceeds with other setup steps
        notes:
          - _ulid: 01KFADB7BNJMB4YSV75Z79SS7G
            created_at: 2026-01-19T05:58:47.925Z
            author: "@claude"
            content: >-
              Enhancement: Auto-detect and setup existing kspec repos


              **Problem:** When cloning a repo that already uses kspec (has kspec-meta branch),
              users must manually run 'git worktree add .kspec kspec-meta'. This is easy to forget,
              causing confusing 'no kspec found' errors.


              **Solution:** Detect this situation and offer to fix it automatically.


              **Detection logic:**

              1. Check if .kspec directory exists and is a valid worktree

              2. If not, check if kspec-meta branch exists (git branch --list kspec-meta)

              3. If branch exists but worktree doesn't, prompt user or auto-create with flag


              **New option:** --auto-worktree

              - Automatically creates worktree without prompting

              - Useful for CI/CD and scripted setups


              **Integration points:**

              - kspec setup: Primary place for this check

              - Other commands: Could also check and prompt (optional, may be too intrusive)
            supersedes: null
      - _ulid: 01KF3ECD4PQ01ENY5PVSPTKK9X
        slugs:
          - cmd-module-add
        title: kspec module add
        type: requirement
        tags:
          - cli
          - dx
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T13:02:14.166Z
        description: |-
          kspec module add [options]

          Create a new module YAML file.

          Options:
          - --title <title>: Module title (required)
          - --slug <slug>: Module slug (required, becomes filename)
          - --description <desc>: Module description
          - --tag <tag...>: Tags for the module

          Creates:
          1. modules/{slug}.yaml with module item
          2. Adds include to manifest

          Example:
            kspec module add --title "Auth System" --slug auth
            # Creates modules/auth.yaml
            # Adds to manifest: includes: - modules/auth.yaml
        acceptance_criteria:
          - id: ac-1
            given: valid title and slug provided
            when: kspec module add --title 'Auth' --slug auth runs
            then: modules/auth.yaml created with module item structure
          - id: ac-2
            given: module created successfully
            when: module add completes
            then: manifest includes array has new entry for module file
          - id: ac-3
            given: slug 'auth' already exists in spec
            when: kspec module add --title 'Another' --slug auth runs
            then: error about duplicate slug
          - id: ac-4
            given: shadow branch is enabled
            when: module is created
            then: changes are auto-committed to shadow branch
        status:
          maturity: draft
          implementation: implemented
      - _ulid: 01KFADGA7EPEJKTVG91CCVV3YA
        slugs:
          - cmd-clone-for-testing
        title: Test repo setup command
        type: requirement
        tags:
          - cli
          - testing
          - dx
        description: kspec clone-for-testing - Creates isolated repo copy for testing with proper kspec
          setup. Eliminates manual setup errors that can cause confusing test failures.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        notes:
          - _ulid: 01KFADH7GYZ42DXV5XJBCAYNXB
            created_at: 2026-01-19T06:02:04.703Z
            author: "@claude"
            content: >-
              Design: Test repo setup command


              **Problem:** Setting up isolated repos for testing requires multiple manual steps:

              1. Clone or copy the repo

              2. Remove remote origin (avoid accidental pushes)

              3. Ensure kspec-meta branch is available

              4. Create .kspec worktree

              5. Checkout correct branch


              Missing any step causes confusing errors (e.g., stale .kspec data if worktree wasn't
              created).


              **Solution:** Single command that handles all setup steps.


              **Command signature:**

              ```

              kspec clone-for-testing [source] [dest] [options]


              Arguments:
                source    Source repo path (default: current directory)
                dest      Destination path (default: temp directory)

              Options:
                --branch <name>   Branch to checkout after cloning
                --json            Output result as JSON
              ```


              **Implementation approach:**

              1. Use git clone --no-hardlinks for full independent copy

              2. cd into dest, remove origin: git remote remove origin

              3. Check if kspec-meta branch exists: git branch --list kspec-meta

              4. If exists, create worktree: git worktree add .kspec kspec-meta

              5. If --branch specified: git checkout <branch>

              6. Print result path (or JSON)


              **Use cases:**

              - Integration tests that need clean repo state

              - Manual testing of risky operations

              - Reproducing issues in isolation
            supersedes: null
        created: 2026-01-19T06:01:34.703Z
        acceptance_criteria:
          - id: creates-isolated-copy
            given: User needs isolated repo for testing
            when: User runs kspec clone-for-testing [source] [dest]
            then: "Creates full clone of source repo (default: current repo) to dest directory, removes remote
              origin, preserves all branches including kspec-meta"
          - id: sets-up-worktree
            given: Cloned repo has kspec-meta branch
            when: Clone completes
            then: Automatically creates .kspec worktree pointing to kspec-meta branch
          - id: checkout-branch
            given: User specifies --branch flag
            when: User runs kspec clone-for-testing --branch feature-x dest
            then: Checks out specified branch in the cloned repo after setup
          - id: temp-dir-default
            given: No dest argument provided
            when: User runs kspec clone-for-testing
            then: Creates clone in system temp directory with generated name, prints path to stdout
          - id: json-output
            given: --json flag provided
            when: Clone completes successfully
            then: 'Outputs JSON with path to cloned repo: {"path": "/tmp/kspec-test-xxx", "branch": "main"}'
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KF15N59C28PGQYJQNADVFHPA
    slugs:
      - inbox-commands
    title: Inbox Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - cli
      - process
    description: |
      Low-friction capture for ideas that aren't tasks yet.
      Inbox items are simple text entries that can be triaged later.
      Storage: project.inbox.yaml (separate file for clean schema).
    requirements:
      - _ulid: 01KF15N59ESD55YP3PP8EW96AJ
        slugs:
          - cmd-inbox-add
        title: kspec inbox add
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec inbox add <text> [options]

          Options:
          - --tag <tag>: Add tag(s) for categorization (repeatable)

          Quick capture with minimal friction.
          Auto-generates ULID, timestamp, and added_by (from KSPEC_AUTHOR or git).

          Examples:
          - kspec inbox add "maybe we need better error messages"
          - kspec inbox add "refactor auth flow" --tag auth --tag refactor
        implements:
          - "@inbox-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF15N59E5B55QEM6KVJHGSN5
        slugs:
          - cmd-inbox-list
        title: kspec inbox list
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec inbox list [options]

          Options:
          - --tag <tag>: Filter by tag
          - --limit <n>: Limit results
          - --oldest: Sort oldest first (default for triage)

          Shows inbox items. Default sort is oldest first to
          encourage dealing with older items.
        implements:
          - "@inbox-commands"
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF15N59E6WMGPHZ8END163G6
        slugs:
          - cmd-inbox-promote
        title: kspec inbox promote
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec inbox promote <ref> [options]

          Options:
          - --title <title>: Task title (prompts if not provided)
          - --priority <n>: Priority (1-5)
          - --spec-ref <ref>: Link to spec item
          - --type <type>: Task type (task, bug, spike, etc.)
          - --tag <tag>: Add tag(s) to task

          Converts inbox item to task. Prompts for required fields
          if not provided via options. Deletes inbox item after
          successful task creation.

          Examples:
          - kspec inbox promote @01KF0... (interactive)
          - kspec inbox promote @01KF0... --title "Improve errors" --priority 2
        implements:
          - "@inbox-commands"
        traits:
          - "@trait-json-output"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF15N59ER8D2XAGND1003ZSH
        slugs:
          - cmd-inbox-delete
        title: kspec inbox delete
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec inbox delete <ref> [options]

          Options:
          - --force: Skip confirmation

          Removes inbox item. Use when idea is no longer relevant.
        implements:
          - "@inbox-commands"
        traits:
          - "@trait-json-output"
          - "@trait-confirmation-prompt"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
  - _ulid: 01KF1A8NP424N6FAY64C7T49R2
    slugs:
      - fuzzy-matching
    title: Fuzzy Matching
    type: feature
    priority: medium
    tags:
      - dx
      - cli
    description: Infrastructure for fuzzy string matching across kspec. Enables approximate matching for
      item/task search and CLI command suggestions. Uses Levenshtein distance or similar algorithm
      for scoring matches.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-15T17:11:48.677Z
    requirements:
      - _ulid: 01KF1A8Z6VHV4TKGS9GNZHSDZA
        slugs:
          - fuzzy-item-search
        title: Grep-like Content Search
        type: requirement
        tags:
          - dx
          - search
        description: >-
          kspec search <pattern>

          kspec item list --grep <pattern>

          kspec tasks list --grep <pattern>


          Enables content search across all spec items and tasks. Searches ALL text content
          including titles, descriptions, notes, and acceptance criteria text.


          Behavior:

          - Pattern is treated as regex (like grep)

          - Case-insensitive by default

          - Searches recursively through all text fields

          - Returns the ITEMS/TASKS themselves (not line snippets)

          - Shows which field(s) matched for context

          - Works with existing filters (--type, --tag, etc.)


          Examples:

          - kspec search "TODO" → returns all items/tasks mentioning TODO

          - kspec search "shadow.*branch" → regex pattern across all content

          - kspec tasks list --grep "authentication" → tasks mentioning authentication


          Output shows items with match location:

          01KF1234 [pending] P2 Implement auth flow
            matched: notes[1].content, description

          The search finds items; the pattern is just the filter criteria.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-15T17:11:58.428Z
        status:
          maturity: draft
          implementation: implemented
        acceptance_criteria:
          - id: ac-1
            given: A user runs kspec search "TODO"
            when: The search runs across all loaded items and tasks
            then: Returns items/tasks where any text field matches, showing the item itself (not just the
              matched line)
          - id: ac-2
            given: A user searches with a regex pattern like "shadow.*branch"
            when: The pattern is applied to content
            then: Matches using JavaScript regex semantics, case-insensitive by default
          - id: ac-3
            given: An item matches in multiple fields
            when: Results are displayed
            then: "Shows which field(s) matched (e.g., matched: notes[1].content, description) for context"
          - id: ac-4
            given: A match is found in nested content like notes or AC
            when: Results are displayed
            then: The full item is returned with match location indicator, not just the matched text snippet
          - id: ac-5
            given: User combines search with filters like --type task or --status pending
            when: Search runs
            then: Filters are applied first, then content search within the filtered set
          - id: ac-6
            given: Search finds no matches
            when: Results are displayed
            then: Shows empty result with helpful message, not an error
          - id: ac-7
            given: user runs kspec search with a pattern
            when: search executes
            then: searches inbox items and meta entities (observations, agents, workflows) in addition to spec
              items and tasks
        traits:
          - "@trait-json-output"
          - "@trait-filterable-list"
          - "@trait-semantic-exit-codes"
          - "@trait-error-guidance"
      - _ulid: 01KF1A991VFFQ99EBQGQ9XB55D
        slugs:
          - fuzzy-command-suggest
        title: CLI Command Suggestions on Error
        type: requirement
        tags:
          - dx
          - cli
          - errors
        description: |-
          When user enters an invalid command, suggest close matches.

          Behavior:
          - On unknown command, compute distance to all valid commands
          - If close match found (e.g., 'task list' vs 'tasks list'), suggest it
          - Threshold-based: only suggest if match is close enough
          - Also handles subcommand typos (e.g., 'inbox ad' → 'inbox add')

          Output format:
            error: Unknown command 'task list'
            Did you mean: kspec tasks list?

          Consider also accepting common aliases:
          - 'task' as alias for 'tasks' (singular/plural flexibility)
          - 'ls' as alias for 'list'
          - Other common patterns from git/npm conventions
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-15T17:12:08.507Z
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KF3M0JFKF5578HVXEE99F0ZT
    slugs:
      - auto-cli-docs
    title: Auto-Generated CLI Documentation
    type: feature
    tags:
      - dx
      - documentation
    description: CLI help system that auto-generates command syntax from Commander.js definitions.
      Eliminates manual sync between code and documentation. Combines auto-generated syntax with
      curated conceptual content.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-16T14:40:37.876Z
    acceptance_criteria:
      - id: ac-1
        given: The CLI program is registered with commands
        when: extractCommandTree() is called
        then: Returns complete tree with names, descriptions, options, arguments, and subcommands
      - id: ac-2
        given: A help topic exists for the 'task' command group
        when: "'kspec help task' is run"
        then: The Commands section dynamically lists ALL current task subcommands including recent additions
      - id: ac-3
        given: The CLI has multiple command groups
        when: "'kspec help --all' is run"
        then: Output shows every command with all options and descriptions as a full reference
      - id: ac-4
        given: An agent needs structured CLI documentation
        when: "'kspec help --json' is run"
        then: Returns JSON with complete command tree for programmatic consumption
      - id: ac-5
        given: A new subcommand is added to Commander definition
        when: "'kspec help <parent>' is run without updating help.ts"
        then: The new subcommand appears in help output automatically
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KF56RNN2KPVCDCY0KPK1TTBQ
    slugs:
      - cli-ralph
    title: Ralph command - automated task loop
    type: feature
    tags: []
    description: Automated task loop using ACP protocol. Runs claude-code-acp agent in a loop to process
      kspec tasks autonomously with full event logging and streaming output.
    depends_on:
      - "@acp-client"
      - "@session-events"
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-17T05:27:36.354Z
    acceptance_criteria:
      - id: ac-1
        given: ready tasks exist
        when: kspec ralph is run with --max-loops N
        then: spawns ACP agent and runs up to N iterations
      - id: ac-2
        given: no ready tasks exist
        when: kspec ralph is run
        then: command exits with message indicating no ready tasks
      - id: ac-3
        given: a loop iteration starts
        when: agent picks and works on a task
        then: agent uses task start, task note, and task complete commands per working procedure
      - id: ac-4
        given: a loop iteration ends with work still in progress
        when: agent cannot complete the task in one iteration
        then: agent commits WIP, adds note documenting progress, and task remains in_progress for next
          iteration
      - id: ac-5
        given: a loop iteration completes (task done or WIP)
        when: there are uncommitted changes
        then: agent commits the changes with appropriate message
      - id: ac-6
        given: --dry-run flag is provided
        when: kspec ralph --dry-run is run
        then: shows the prompt that would be sent without executing agent
      - id: ac-7
        given: agent returns error during iteration
        when: the error occurs
        then: retry the iteration up to max-retries times before failing the loop
      - id: ac-8
        given: multiple consecutive iterations fail after all retries
        when: the failure count reaches max-failures threshold
        then: the loop exits early with an error message
      - id: ac-9
        given: --adapter flag is provided
        when: kspec ralph --adapter <id> is run
        then: uses specified adapter (default claude-code-acp)
      - id: ac-10
        given: session starts
        when: agent spawns
        then: creates new session with ULID and logs session.start event
      - id: ac-11
        given: agent streams updates
        when: updates arrive
        then: displays streaming output to CLI and logs to session events
      - id: ac-12
        given: prompt is sent
        when: iteration starts
        then: logs prompt.sent event with full prompt content
      - id: ac-13
        given: session ends
        when: loop completes or errors
        then: logs session.end event with status and triggers commit
      - id: ac-14
        given: a loop iteration starts
        when: building prompt for the agent
        then: creates a fresh ACP session so each iteration has a clean context window
      - id: ac-15
        given: --focus flag is provided with instructions
        when: building prompt for each iteration
        then: includes the focus instructions prominently in the prompt, emphasizing they apply to all
          iterations
      - id: ac-16
        given: ralph loop is running
        when: checking for available tasks
        then: "only considers tasks with automation: eligible, ignoring manual_only, needs_review, and
          unassessed tasks"
      - id: ac-17
        given: ralph loop is running with --restart-every N (N > 0)
        when: iteration completes and iteration number is divisible by N
        then: agent process is killed and respawned to prevent memory buildup
      - id: ac-18
        given: --restart-every 0 is specified
        when: iterations complete
        then: agent process is never restarted (maintains single agent instance)
    status:
      maturity: draft
      implementation: implemented
    requirements:
      - _ulid: 01KF6NBAZPZTWADHJJK95B2K6C
        slugs:
          - ralph-output-formatting
        title: Ralph Output Formatting
        type: requirement
        tags: []
        description: >-
          Structured formatting for ralph streaming output. Translates ACP events into readable CLI
          output with visual separation between agent messages, tool calls, and results. Follows
          patterns from kynetic chat/session UI with chalk-based colors, section headers,
          timestamps, and noise suppression.


          Key learnings from kynetic beads history:

          - Finalization is critical for streaming state

          - Library limitations guide input format requirements

          - Tests must verify end-to-end rendered output

          - Treat LLM output as untrusted content


          Implementation references:

          - ui-event-translator.ts pattern for ACP event translation

          - event-display.ts for display summaries

          - aggregated-message.ts for message structure
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-17T19:01:42.519Z
        acceptance_criteria:
          - id: ac-1
            given: ACP agent streams agent_message events
            when: messages are displayed in CLI
            then: messages show with visual separation (section header or newline), chalk.blue for content, and
              streaming indicator while incomplete
          - id: ac-2
            given: ACP agent streams tool_call and tool_call_update events
            when: tool calls are displayed in CLI
            then: shows tool name, input summary (command for Bash, path for Read/Write, pattern for Grep/Glob),
              status indicator (pending/running/completed/failed), and truncated output (first 20
              lines or 1000 chars with expansion hint)
          - id: ac-3
            given: ralph is streaming output
            when: each significant event is displayed
            then: shows relative timestamp from session start (e.g., +5s, +2m) prefixed to the event line
          - id: ac-4
            given: ACP agent emits debug or internal log messages (e.g., 'No onPostToolUseHook found')
            when: these messages arrive in the event stream
            then: messages are suppressed from CLI output (logged to session events only)
          - id: ac-5
            given: message stream ends (empty chunk or status event)
            when: finalization signal is received
            then: current streaming message is marked complete and any pending formatting is applied
        status:
          maturity: draft
          implementation: implemented
      - _ulid: 01KFAD8YSJH4C245400MPXVC5J
        slugs:
          - ralph-adapter-validation
        title: Adapter validation on startup
        type: requirement
        tags:
          - ralph
          - dx
          - validation
        description: Validate that the specified ACP adapter package exists before attempting to spawn the
          agent. Provides clear error message instead of cryptic connection failures.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        notes: []
        created: 2026-01-19T05:57:33.619Z
        acceptance_criteria:
          - id: valid-adapter-proceeds
            given: User runs kspec ralph with valid adapter (default or --adapter)
            when: Startup validation runs
            then: Adapter package is verified to exist (via npm/npx check), and command proceeds to spawn agent
          - id: invalid-adapter-error
            given: User runs kspec ralph --adapter @nonexistent/package
            when: Startup validation runs
            then: "Command exits immediately with exit code 3 and error message: 'Adapter package not found:
              @nonexistent/package. Install with: npm install -g @nonexistent/package'"
          - id: validation-before-spawn
            given: Adapter validation fails
            when: Error is shown
            then: No ACP agent process is spawned, no session is created, no events are logged
        status:
          maturity: draft
          implementation: implemented
      - _ulid: 01KFR7T4FV90ZS4RCBF8WCTRHB
        slugs:
          - ralph-skill-delegation
        title: Ralph Skill Delegation
        type: requirement
        tags: []
        description: Ralph prompt refactoring to delegate to skills. Ralph includes skill invocation as
          literal text in prompt; it does NOT detect or parse skill invocation from agent output.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:27.100Z
        acceptance_criteria:
          - id: ac-1
            given: ralph iteration starts
            when: prompt built
            then: includes iteration N/M, session ID, no-human flag
          - id: ac-2
            given: prompt built
            when: content examined
            then: does NOT contain step-by-step task work instructions
          - id: ac-3
            given: prompt built
            when: content examined
            then: contains literal strings /task-work loop and /reflect loop
          - id: ac-4
            given: agent output received
            when: ralph processes output
            then: ralph does NOT parse or detect skill invocation patterns
          - id: ac-5
            given: iteration begins
            when: agent follows prompt
            then: invokes /task-work loop
          - id: ac-6
            given: pending_review exists
            when: agent follows prompt
            then: spawns subagent with /pr-review @task-ref
          - id: ac-7
            given: iteration ends
            when: agent follows prompt
            then: invokes /reflect loop
      - _ulid: 01KFR7T8HYW22JJQ1KNPZ17Q51
        slugs:
          - ralph-subagent-spawning
        title: Ralph Subagent Spawning
        type: requirement
        tags: []
        description: Ralph can spawn ACP subagents for dedicated tasks (e.g., PR review). Subagents are
          separate Claude Code processes with focused prompts. Subagents run sequentially (ralph
          waits for completion).
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:31.263Z
        acceptance_criteria:
          - id: ac-1
            given: ralph needs subagent
            when: spawn initiated
            then: new ACP process started with dedicated prompt
          - id: ac-2
            given: subagent spawned
            when: prompt provided
            then: prompt includes task ref, skill to invoke (/pr-review @task), and context
          - id: ac-3
            given: subagent running
            when: ralph behavior
            then: ralph waits for subagent completion before continuing
          - id: ac-4
            given: subagent runs
            when: display
            then: subagent output rendered same as main agent (single stream)
          - id: ac-5
            given: subagent completes
            when: signaling
            then: task status change (completed/needs_review) indicates outcome
          - id: ac-6
            given: multiple pending_review tasks
            when: spawning
            then: processes one at a time sequentially
          - id: ac-7
            given: subagent runs
            when: resource management
            then: respects ralph's --max-retries and failure limits
          - id: ac-8
            given: ralph iteration begins
            when: ralph checks task statuses
            then: pending_review tasks detected trigger subagent spawn by ralph (host) before main agent
              iteration continues
          - id: ac-9
            given: subagent is running
            when: subagent exceeds timeout (default 10 minutes)
            then: "ralph terminates subagent and marks task automation: needs_review with timeout note"
          - id: ac-10
            given: subagent prompt is built
            when: context is assembled
            then: "includes: full task details (kspec task get), linked spec with ACs if spec_ref exists,
              current git branch"
          - id: ac-11
            given: subagent output is displayed
            when: rendering to terminal
            then: output includes [SUBAGENT] prefix to distinguish from main agent
  - _ulid: 01KF68D20XCSVJMJW2YZPBJGV7
    slugs:
      - acp-client
    title: ACP Protocol Client
    type: feature
    tags: []
    description: JSON-RPC 2.0 based client for Agent Client Protocol communication. Handles
      bidirectional stdio communication with ACP-compliant agents, request/response correlation,
      session lifecycle, and event streaming.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-17T15:15:27.389Z
    acceptance_criteria:
      - id: ac-1
        given: an ACP agent process
        when: client.initialize() is called
        then: returns agent capabilities including supported features
      - id: ac-2
        given: an initialized client
        when: client.newSession({ cwd, _meta }) is called
        then: creates a new session and returns sessionId
      - id: ac-3
        given: an active session
        when: client.prompt({ sessionId, prompt }) is called
        then: sends prompt and returns PromptResponse with stopReason
      - id: ac-4
        given: streaming updates from agent
        when: update events arrive
        then: client emits 'update' events with sessionId and update data
      - id: ac-5
        given: a pending request
        when: no response within timeout (default 30s, 5min for prompt)
        then: request rejects with timeout error
      - id: ac-6
        given: incoming agent activity (requests/notifications)
        when: activity is detected
        then: timeout timers reset (keepalive mechanism)
      - id: ac-7
        given: an active session
        when: client.cancel(sessionId) is called
        then: sends cancel request (optional method with graceful fallback)
      - id: ac-8
        given: client is closed
        when: any method is called
        then: throws 'client closed' error
      - id: ac-9
        given: malformed JSON from agent
        when: message is parsed
        then: sends JSON-RPC parse error response
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KF68ESKJB4XHRM3MNFD93VV2
    slugs:
      - session-events
    title: Session Event Storage
    type: feature
    tags: []
    description: JSONL-based event storage for agent sessions. Provides append-only event logs for
      auditability, session metadata tracking, and integration with kspec commit boundaries.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-17T15:16:24.306Z
    acceptance_criteria:
      - id: ac-1
        given: a new session is started
        when: createSession(id, metadata) is called
        then: creates .kspec/sessions/{id}/ directory with session.yaml metadata file
      - id: ac-2
        given: an active session
        when: appendEvent(id, event) is called
        then: appends JSON line to events.jsonl with auto-assigned ts and seq
      - id: ac-3
        given: events are appended
        when: written to disk
        then: uses atomic append (appendFileSync) for crash safety
      - id: ac-4
        given: a session exists
        when: readEvents(id) is called
        then: returns all events in sequence order
      - id: ac-5
        given: session metadata
        when: stored
        then: "includes: task_id (optional), agent_type, status, started_at, ended_at"
      - id: ac-6
        given: session ends
        when: updateSessionStatus(id, status) is called
        then: updates metadata with status and ended_at timestamp
      - id: ac-7
        given: events are accumulated
        when: a commit boundary is reached (task complete, session end)
        then: events are included in next kspec commit
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KF68JFQF2N4VAKDWNE9P9Z70
    slugs:
      - acp-handlers
    title: ACP File/Terminal Handlers
    type: feature
    tags:
      - deferred
    description: "Implement fs read/write and terminal handlers for ACP agents with security checks.
      Deferred: Test if claude-code-acp works without them first."
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-17T15:18:25.264Z
  - _ulid: 01KF68JJ2XEPEEN5XTKQSJ36MT
    slugs:
      - ralph-orchestrator
    title: Orchestrator Agent Mode
    type: feature
    tags:
      - deferred
    description: "Higher-level agent that coordinates task agents, provides guidance beyond raw tasks.
      Deferred: Requires design of orchestrator prompt, session coordination, agent spawning."
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-17T15:18:27.678Z
  - _ulid: 01KFACEZX6E7G3XJAHE3H8ZT8B
    slugs:
      - multi-ref-batch
    title: Multi-ref batch operations
    type: feature
    tags:
      - cli
      - dx
    description: "Support --refs @a @b @c flag pattern for batch operations on multiple items/tasks.
      Uses hybrid syntax: single-ref positional remains for backward compat, --refs flag enables
      batch operations. Applies to: task complete, task cancel, task set, task delete, item set,
      item delete, inbox delete."
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    notes:
      - _ulid: 01KFACGT1MYEZM3WQG3P60QCWZ
        created_at: 2026-01-19T05:44:22.325Z
        author: "@claude"
        content: >-
          Design decisions and implementation context:


          **Syntax choice:** Hybrid approach selected over variadic positional or flag-only.
          Rationale: maintains backward compatibility with existing single-ref positional usage
          while adding batch capability via --refs flag. Matches existing pattern used by
          --depends-on.


          **Error handling:** Continue-and-report strategy (not fail-fast). Process all refs,
          succeed where possible, report failures at end. Consistent with existing item patch --bulk
          behavior.


          **Exit codes for batch operations:**

          - 0: All operations succeeded

          - 1: All operations failed  

          - 2: Partial failure (some succeeded, some failed)

          - 3: Invalid input (empty refs, mutual exclusion violation)


          **Commands in scope (7 total):**

          - task complete --refs

          - task cancel --refs

          - task set --refs

          - task delete --refs

          - item set --refs

          - item delete --refs

          - inbox delete --refs


          **Edge cases to handle:**

          1. Duplicate refs in --refs: Dedupe silently, process each unique ref once

          2. Ref resolves to wrong type (e.g., spec ref passed to task command): Fail for that
          specific ref with 'not a task' error

          3. Options unsafe for batch (e.g., --slug): Document which options shouldn't be used with
          multi-refs
        supersedes: null
    created: 2026-01-19T05:43:22.791Z
    acceptance_criteria:
      - id: basic-multi-ref-syntax
        given: A command that supports multi-ref (e.g., task complete)
        when: User runs kspec task complete --refs @task-a @task-b @task-c
        then: The operation applies to all three refs, each ref is processed independently, and results are
          collected for final output
      - id: backward-compatibility
        given: Existing single-ref positional usage
        when: User runs kspec task complete @task-a
        then: Behavior is identical to current implementation with no deprecation warnings
      - id: mutual-exclusion-error
        given: Both positional ref AND --refs flag provided
        when: User runs kspec task complete @task-a --refs @task-b @task-c
        then: Command exits with code 3, error message says cannot use both positional ref and --refs flag,
          no operations are performed
      - id: partial-failure-handling
        given: --refs with mix of valid and invalid refs
        when: User runs kspec task complete --refs @valid-task @nonexistent @another-valid
        then: Valid refs are processed successfully, invalid refs are skipped with error recorded, exit code
          is 2 (partial failure), output shows which succeeded and which failed with reasons
      - id: human-output-format
        given: Batch operation completes (success or partial)
        when: Output is rendered without --json flag
        then: First line shows summary count (e.g., Completed 2 of 3 tasks:), each item listed with status
          indicator (checkmark for success, X for failure), failed items include failure reason
      - id: json-output-format
        given: Batch operation with --json flag
        when: Command completes
        then: "Output is valid JSON with structure: {success: boolean, summary: {total, succeeded, failed},
          results: [{ref, ulid, status, error?, message?}]}"
      - id: empty-refs-error
        given: --refs flag with no values
        when: User runs kspec task complete --refs
        then: Command exits with code 3, error message says --refs requires at least one reference, no
          operations are performed
      - id: ref-resolution-uses-existing
        given: Refs can be slugs, full ULIDs, or ULID prefixes
        when: User runs kspec task complete --refs @task-slug @01KFAB95 @01KFA
        then: Each ref resolves using existing ReferenceIndex.resolve() logic, ambiguous ULID prefixes are
          reported as errors for that specific ref, other refs in the batch still process normally
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KFR7K7BF3XK8TWVAP191TDH1
    slugs:
      - skill-commands
    title: Skill Commands
    type: feature
    tags: []
    description: Container for skill-related behavior specs. Skills are structured agents invoked via
      Claude Code's /skill mechanism with optional mode arguments.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits: []
    notes: []
    created: 2026-01-24T14:47:40.656Z
    acceptance_criteria:
      - id: ac-1
        given: skill exists
        when: /skill-name invoked
        then: skill executes with default behavior
      - id: ac-2
        given: skill supports modes
        when: /skill-name mode invoked
        then: skill behavior changes per mode
    requirements:
      - _ulid: 01KFR7SA4EX8D3THW5RX714C5B
        slugs:
          - skill-loop-mode
        title: Skill Loop Mode
        type: requirement
        tags: []
        description: Generic loop mode argument handling for skills. When a skill receives the loop
          argument, it modifies behavior for automation context.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:00.111Z
        acceptance_criteria:
          - id: ac-1
            given: skill supports loop mode
            when: /skill-name loop invoked
            then: skill recognizes argument, modifies behavior
          - id: ac-2
            given: skill has loop mode
            when: loop invoked
            then: skill uses @workflow-loop variant
          - id: ac-3
            given: loop mode active
            when: confirmation point reached
            then: confirmation skipped
          - id: ac-4
            given: loop mode encounters error
            when: error caught
            then: note added, workflow continues
      - _ulid: 01KFR7SDZZ26BK0SEWRYYEGRAD
        slugs:
          - task-work-loop-skill
        title: Task Work Loop Skill
        type: requirement
        tags: []
        description: Skill definition for /task-work loop. Invokes @task-work-loop-workflow for loop mode
          behavior.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:04.063Z
        acceptance_criteria:
          - id: ac-1
            given: ralph iteration starts
            when: agent acts
            then: /task-work loop invoked
          - id: ac-2
            given: loop mode active
            when: skill executes
            then: uses @task-work-loop workflow
          - id: ac-3
            given: ready tasks exist
            when: skill filters
            then: "only automation: eligible shown"
          - id: ac-4
            given: multiple eligible tasks
            when: skill selects
            then: follows loop selection order
      - _ulid: 01KFR7SH5S00QS3J3P3NJ1A48Q
        slugs:
          - reflect-loop-skill
        title: Reflect Loop Skill
        type: requirement
        tags: []
        description: Skill definition for /reflect loop. Invokes @session-reflect-loop-workflow for loop
          mode behavior.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:07.322Z
        acceptance_criteria:
          - id: ac-1
            given: ralph iteration ends
            when: agent acts
            then: /reflect loop invoked
          - id: ac-2
            given: loop mode active
            when: skill executes
            then: uses @session-reflect-loop workflow
          - id: ac-3
            given: potential capture identified
            when: skill evaluates
            then: MUST search existing first
          - id: ac-4
            given: uncertain friction found
            when: skill evaluates
            then: item NOT captured
          - id: ac-5
            given: captures complete
            when: skill finishes
            then: user not prompted
      - _ulid: 01KFR7SMRYBM0QWYKJDPJ9BA5J
        slugs:
          - pr-review-skill
        title: PR Review Skill
        type: requirement
        tags: []
        description: "Skill definition for /pr-review - invoked in ACP subagent context. Key focus: AC
          coverage verification + spec alignment (not just tests passing). Delegates to
          @pr-review-loop-workflow."
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:11.006Z
        acceptance_criteria:
          - id: ac-1
            given: /pr-review @task-ref invoked
            when: skill executes
            then: starts @pr-review-loop-workflow
          - id: ac-2
            given: skill invoked without task ref
            when: skill validates
            then: errors with task reference required
          - id: ac-3
            given: task ref provided but no PR exists
            when: skill validates
            then: errors with no PR found for task
          - id: ac-4
            given: skill documentation
            when: content examined
            then: emphasizes AC coverage AND spec alignment as quality gates
          - id: ac-5
            given: skill starts
            when: execution
            then: delegates all behavior to @pr-review-loop-workflow
      - _ulid: 01KFR7SRJHP46DWKDWQZEEQMJR
        slugs:
          - loop-mode-error-handling
        title: Loop Mode Error Handling
        type: requirement
        tags: []
        description: "Error handling specific to loop mode. Failures tracked via task notes with
          [LOOP-FAIL:N] prefix. N=3 triggers automation: needs_review."
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-24T14:51:14.898Z
        acceptance_criteria:
          - id: ac-1
            given: error during task work
            when: error caught
            then: note added with [LOOP-FAIL:N] prefix and error description
          - id: ac-2
            given: non-fatal error occurs
            when: error handled
            then: workflow continues to next task
          - id: ac-3
            given: task fails
            when: note added
            then: note includes [LOOP-FAIL:N] where N = previous count + 1
          - id: ac-4
            given: task has prior [LOOP-FAIL:N] notes
            when: new failure occurs
            then: N is parsed from latest note and incremented
          - id: ac-5
            given: task fails with N reaching 3
            when: threshold reached
            then: "task marked automation: needs_review with summary"
          - id: ac-6
            given: task completes successfully
            when: workflow finishes
            then: no reset needed; count is per-task in notes
          - id: ac-7
            given: workflow encounters error
            when: error evaluated
            then: failure = tests fail, PR blocked, exception, or agent reports cannot complete
          - id: ac-8
            given: agent iteration completes
            when: task remains in_progress with no progress note added
            then: counts as implicit failure (agent could not complete)
requirements:
  - _ulid: 01KF109BR2PZACTM1Y91NWEEJQ
    slugs:
      - cmd-session-checkpoint
    title: kspec session checkpoint
    type: requirement
    tags: []
    description: >-
      Pre-stop hook for Claude Code integration.


      Checks for uncommitted work before allowing session to end:

      - Uncommitted git changes (staged, unstaged, untracked)

      - Tasks in in_progress status

      - Incomplete todos on active tasks


      One-time trigger: Reads stop_hook_active from Claude Code stdin JSON to detect retry. First
      trigger blocks with instructions, subsequent triggers allow stop.


      Output: JSON formatted for Claude Code hook consumption with clear kspec-branded message
      instructing agent to document progress and commit changes. Uses {"decision": "block",
      "reason": "..."} format.


      Installation: kspec setup automatically installs this hook to project-level
      .claude/settings.json for Claude Code users. Hook format requires matcher field (even if empty
      string).


      Acceptance Criteria:

      - AC1: Instructions are numbered sequentially based on which issues apply (dynamic numbering,
      not hardcoded)

      - AC2: Only relevant instructions shown (e.g., if no in_progress tasks, those steps are
      omitted)

      - AC3: Exit silently with no output when session can end cleanly
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-15T14:17:25.508Z
    status:
      maturity: draft
      implementation: implemented
    requirements:
      - _ulid: 01KF1D9G8HNSYRTPTPZZ4NVXJ1
        slugs:
          - cmd-session-prompt-check
        title: kspec session prompt-check
        type: requirement
        tags: []
        description: >-
          UserPromptSubmit hook for spec-first workflow reinforcement.


          Outputs a lean reminder on every user prompt: '[kspec] Before implementing behavior
          changes, check spec coverage. Update spec first if needed.'


          Design rationale:

          - Always injects (no filtering) - Claude is smart enough to apply when relevant

          - Minimal token overhead - short, instructive message

          - Non-blocking - context injection, not gating


          Installation: kspec setup automatically installs this hook alongside session checkpoint to
          project-level .claude/settings.json for Claude Code users.


          Acceptance Criteria:

          - AC1: Outputs single-line reminder to stdout

          - AC2: No stdin parsing required (stateless)

          - AC3: Installed by setup command as UserPromptSubmit hook
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-15T18:04:41.618Z
  - _ulid: 01KF2C5P8BGYKT9GDTYNXTSTQM
    slugs:
      - cmd-session-start
    title: kspec session start
    type: requirement
    tags: []
    description: "Display session context for starting work. Shows: active tasks, recently completed,
      ready tasks, inbox items, recent commits, working tree status. Options: --brief (default),
      --full, --since <time>, --no-git, -n <limit>. Output is human-readable with sections for each
      context type. Designed as the first command agents run to orient themselves."
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-16T03:04:22.540Z
    requirements:
      - _ulid: 01KF2C60QQP8CT8F77PTRGQ7YB
        slugs:
          - session-start-hints
        title: Contextual Command Hints
        type: requirement
        tags: []
        description: "Add a 'Quick Commands' section to session start output showing relevant commands based
          on current state. Commands are contextual: task note/complete when active work exists,
          task start when ready tasks available, inbox promote for oldest inbox item, git commit
          when working tree dirty. Uses actual refs from session context for copy-paste
          convenience."
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T03:04:33.272Z
        status:
          maturity: draft
          implementation: implemented
        acceptance_criteria:
          - id: ac-1
            given: ready tasks exist in the project
            when: kspec session start runs
            then: Quick Commands section shows 'kspec task start @ref' hint
          - id: ac-2
            given: a task is in progress
            when: kspec session start runs
            then: Quick Commands section shows task note and complete hints
    status:
      implementation: implemented
  - _ulid: 01KFFG8XS20YMJR11CA4YZNX9N
    slugs:
      - spec-log-empty-repo
    title: Log Empty Repo Handling
    type: requirement
    tags: []
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-json-output"
      - "@trait-error-guidance"
    notes: []
    created: 2026-01-21T05:26:10.467Z
    description: Handle uninitialized git repos (no commits yet) gracefully instead of showing raw git error.
    acceptance_criteria:
      - id: ac-1
        given: repo has no commits (fresh init)
        when: kspec log executed
        then: "shows info message: No commits in repository yet"
      - id: ac-2
        given: repo has no commits
        when: kspec log @ref executed
        then: "shows info message: No commits in repository yet"
      - id: ac-3
        given: repo has commits but no matches
        when: kspec log @ref executed
        then: shows No commits found for @ref (existing behavior)
      - id: ac-4
        given: JSON mode, no commits
        when: kspec log --json executed
        then: "returns { commits: [], message: No commits in repository yet }"
      - id: ac-5
        given: passthrough args in empty repo
        when: kspec log -- --stat executed
        then: shows info message (not raw git error)
      - id: ac-6
        given: shadow branch has commits, main doesn't
        when: kspec log executed
        then: searches shadow branch, shows any matches found
    status:
      maturity: draft
      implementation: implemented
