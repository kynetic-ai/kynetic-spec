_ulid: 01KF1XMETA0000000000000000
slugs:
  - meta
  - meta-spec
  - meta-module
title: Meta-Spec System
type: module
status:
  maturity: draft
  implementation: implemented
description: |
  Meta-spec is the layer that defines HOW work happens, separate from
  WHAT is being built (spec) and tracking WORK (tasks).

  The key distinction:
  - Spec: What to build (features, requirements)
  - Tasks: Work to do (implement feature X)
  - Meta-spec: How to work (check spec before implementing)

  Meta-spec enables a self-improvement loop:
  1. Define workflows → 2. Track adherence → 3. Identify friction →
  4. Propose improvements → 5. Update workflows → (repeat)

  Meta-spec complements prose docs (CLAUDE.md, AGENTS.md) rather than
  replacing them. Structured definitions + prose guidance work together.
features:
  - _ulid: 01KF1XMNF00000000000000000
    slugs:
      - meta-manifest
      - meta-file
    title: Meta Manifest
    type: feature
    status:
      maturity: draft
      implementation: verified
    priority: high
    tags:
      - mvp
      - meta
    description: |
      The meta manifest (kynetic.meta.yaml) is the root file for process
      definitions. It lives alongside kynetic.yaml and defines agents,
      workflows, conventions, and observations.

      Unlike spec items which define product features, meta items define
      how work is done on the project.
    acceptance_criteria:
      - id: ac-meta-manifest-1
        given: a project with kynetic.yaml
        when: kynetic.meta.yaml is created with valid structure
        then: >
          kspec meta show outputs summary with counts for agents, workflows, conventions, and
          observations (exit code 0)
      - id: ac-meta-manifest-2
        given: a meta manifest exists
        when: kspec validate runs
        then: >
          output includes "Meta: X agents, Y workflows, Z conventions" line; validation errors for
          meta items use "meta:" prefix to distinguish from spec errors
      - id: ac-meta-manifest-3
        given: kynetic.meta.yaml has invalid schema
        when: kspec validate runs
        then: >
          exits with code 1; error message identifies the invalid field path and expected type
          (e.g., "meta:agents[0].capabilities: expected array")
    requirements:
      - _ulid: 01KF1XMNF10000000000000000
        slugs:
          - meta-manifest-format
        title: Meta Manifest Format
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Meta manifest structure:

          ```yaml
          kynetic_meta: "1.0"

          agents:
            - _ulid: ...
              id: claude
              name: Claude Code Agent
              ...

          workflows:
            - _ulid: ...
              id: spec-first
              trigger: behavior change
              ...

          conventions:
            - _ulid: ...
              domain: commits
              ...

          observations:
            - _ulid: ...
              type: friction
              ...

          includes:
            - meta/agents.yaml
            - meta/workflows.yaml
          ```

          Version field enables schema evolution.
        implements:
          - "@meta-manifest"
      - _ulid: 01KF1XMNF20000000000000000
        slugs:
          - meta-includes
        title: Meta Includes
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Meta manifest supports includes for organization:

          ```yaml
          includes:
            - meta/agents.yaml
            - meta/workflows.yaml
            - meta/conventions.yaml
          ```

          Allows splitting large meta-specs into focused files.
          Same pattern as spec manifest includes.
        implements:
          - "@meta-manifest"
      - _ulid: 01KF1XMNF30000000000000000
        slugs:
          - meta-validation
        title: Meta Validation Integration
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          `kspec validate` includes meta-spec validation:

          - Schema validation for all meta item types
          - Reference resolution (@refs in workflows, observations)
          - Cross-validation with product spec (meta-refs exist)

          Unified validation ensures consistency across both layers.
        implements:
          - "@meta-manifest"
  - _ulid: 01KF1XAGT00000000000000000
    slugs:
      - agent-definitions
      - agents
    title: Agent Definitions
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - meta
      - agents
    description: |
      Agent definitions describe the roles, capabilities, and conventions
      for agents (AI or human) working on the project. They're trackable
      items that can be referenced by tasks.

      This enables structured understanding of who can do what, and
      provides context for workflow decisions.
    acceptance_criteria:
      - id: ac-agent-1
        given: agents are defined in meta manifest
        when: kspec meta agents runs
        then: >
          outputs table with columns: ID, Name, Capabilities (comma-separated); one row per agent;
          exit code 0
      - id: ac-agent-2
        given: kspec meta agents --json runs
        when: agents are defined
        then: >
          outputs JSON array with objects containing: id, name, description, capabilities (array),
          tools (array), session_protocol (object), conventions (array)
      - id: ac-agent-3
        given: an agent reference @agent-id is used
        when: kspec validate runs
        then: >
          validates reference resolves to an agent definition; error if reference points to
          non-agent meta item
    requirements:
      - _ulid: 01KF1XAGT10000000000000000
        slugs:
          - agent-schema
        title: Agent Schema
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Agent definition structure:

          ```yaml
          - _ulid: 01KF...
            id: claude              # Short identifier
            name: Claude Code Agent # Display name
            description: |
              Primary development agent for this project.
            capabilities:
              - code
              - test
              - refactor
              - review
            tools:                  # Optional
              - kspec
              - git
              - npm
            session_protocol:       # Optional
              start: "kspec session start"
              checkpoint: "kspec session checkpoint"
              end: null
            conventions:            # Agent-specific rules
              - Always use kspec CLI, never edit YAML directly
              - Add notes when completing significant work
          ```

          All agents have ULIDs for tracking and references.
        implements:
          - "@agent-definitions"
      - _ulid: 01KF1XAGT20000000000000000
        slugs:
          - agent-capabilities
        title: Agent Capabilities
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Capabilities are freeform strings describing what an agent can do:

          Standard capabilities:
          - code: Write/modify code
          - test: Write/run tests
          - review: Review code/specs
          - refactor: Restructure code
          - design: Architecture decisions
          - document: Write documentation

          Projects can define custom capabilities as needed.
          Capabilities inform workflow decisions and task routing.
        implements:
          - "@agent-definitions"
      - _ulid: 01KF1XAGT30000000000000000
        slugs:
          - agent-session-protocol
        title: Agent Session Protocol
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Session protocol defines commands agents should run:

          ```yaml
          session_protocol:
            start: "kspec session start"    # At session begin
            checkpoint: "kspec session checkpoint"  # Periodic
            end: "kspec session end"        # At session end (optional)
          ```

          Protocols ensure consistent behavior across sessions.
          Commands are strings (not enforced, just documented).
        implements:
          - "@agent-definitions"
  - _ulid: 01KF1XWKF00000000000000000
    slugs:
      - workflow-definitions
      - workflows
    title: Workflow Definitions
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - meta
      - workflows
    description: |
      Workflows are structured process definitions. They capture the
      steps agents should follow for specific triggers. Unlike prose
      documentation, workflows can be queried and validated.

      Workflows are trackable - tasks can reference them via --meta-ref
      to track work on improving the workflow itself.
    acceptance_criteria:
      - id: ac-workflow-1
        given: workflows are defined in meta manifest
        when: kspec meta workflows runs
        then: |
          outputs table with columns: ID, Trigger, Steps (count); one row per workflow; exit code 0
      - id: ac-workflow-2
        given: kspec meta workflows --verbose runs
        when: workflows are defined
        then: >
          outputs each workflow with full step list; steps show type prefix ([check], [action],
          [decision]) and content; on_fail shown for checks
      - id: ac-workflow-3
        given: a workflow reference @workflow-id is used in meta_ref
        when: kspec validate runs
        then: >
          validates reference resolves to a workflow definition; error message shows "meta_ref must
          point to workflow, agent, or convention"
      - id: ac-workflow-4
        given: kspec meta workflows --json runs
        when: workflows are defined
        then: >
          outputs JSON array with objects containing: id, trigger, description, steps (array of
          {type, content, on_fail?})
    requirements:
      - _ulid: 01KF1XWKF10000000000000000
        slugs:
          - workflow-schema
        title: Workflow Schema
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Workflow definition structure:

          ```yaml
          - _ulid: 01KF...
            id: spec-first         # Short identifier
            trigger: behavior change
            description: |
              Check spec coverage before implementing changes.
            steps:
              - type: check
                content: Does the spec cover this change?
                on_fail: Update spec first
              - type: action
                content: Update spec if needed
              - type: action
                content: Derive task from spec
              - type: action
                content: Implement the change
          ```

          Steps have types: check, action, decision
          on_fail provides guidance when checks fail.
        implements:
          - "@workflow-definitions"
      - _ulid: 01KF1XWKF20000000000000000
        slugs:
          - workflow-steps
        title: Workflow Step Types
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Step types:

          - check: Verification step (pass/fail)
            Has on_fail for what to do if check fails

          - action: Something to do
            No conditional, just execute

          - decision: Branch point
            Has options for different paths

          Steps are executed in order. Agents interpret them,
          they're not automatically enforced.
        implements:
          - "@workflow-definitions"
      - _ulid: 01KF2XWKF40000000000000000
        slugs:
          - workflow-execution-model
        title: Workflow Execution Model
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Workflows are ADVISORY, not AUTOMATED. This is a deliberate design choice.

          Execution model options:

          1. **Documentation** (default): Workflows exist as reference documentation.
             Agents read them when relevant, but no runtime enforcement.
             `kspec meta workflows` displays them for human/agent reference.

          2. **Checklist**: Workflows can be displayed as interactive checklists.
             `kspec meta run @workflow` presents steps one at a time,
             agent confirms each step completion. Progress tracked but not enforced.

          3. **Hook integration**: Workflows can inform Claude Code hooks.
             A hook could query `kspec meta workflows --trigger "commit"`
             and inject relevant workflow steps into the prompt.
             Still advisory - hook provides context, agent decides.

          Why not automation?
          - Workflows describe nuanced processes that require judgment
          - "Check if spec covers this" can't be reliably automated
          - Automation creates brittleness; advisory enables adaptation
          - Trust agents to follow documented processes

          Future: Workflow adherence tracking via observations.
          Friction observations on workflows indicate where guidance fails.
          This creates a feedback loop: observe friction → improve workflow.

          ```yaml
          # Optional execution hints
          steps:
            - type: check
              content: Does the spec cover this change?
              on_fail: Update spec first
              execution:
                mode: prompt  # prompt, silent, or skip
                timeout: null # Optional timeout for automated checks
          ```

          execution.mode values:
          - prompt (default): Show step, wait for confirmation
          - silent: Log step, don't wait
          - skip: Skip in checklist mode (documentation only)
        implements:
          - "@workflow-definitions"
      - _ulid: 01KF1XWKF30000000000000000
        slugs:
          - workflow-triggers
        title: Workflow Triggers
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Triggers are freeform strings describing when workflow applies:

          - "behavior change" - Implementing new/modified behavior
          - "session start" - Beginning a work session
          - "task complete" - Finishing a task
          - "bug fix" - Fixing a defect

          Triggers are documentation, not automation.
          Agents decide when workflows apply based on context.
        implements:
          - "@workflow-definitions"
    features:
      - _ulid: 01KFES9NEJJ4EVPXH45H53B650
        slugs:
          - guided-workflow-execution
        title: Guided Workflow Execution
        type: feature
        tags:
          - meta
          - workflows
        description: Transform workflows into interactive, guided processes with entry/exit criteria,
          workflow runs as durable artifacts, step-by-step progression, and configurable enforcement
          (advisory or strict).
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        traits: []
        notes: []
        created: 2026-01-20T22:44:37.458Z
        acceptance_criteria: []
        requirements:
          - _ulid: 01KFESSZRTYN4J605PA7NYQ8WY
            slugs:
              - workflow-run-foundation
            title: Workflow Run Foundation
            type: requirement
            tags: []
            description: >-
              Schema definitions, storage operations, and basic run lifecycle commands (start, list,
              abort).


              ## Schema Definitions


              ### WorkflowRunSchema

              ```typescript

              {
                _ulid: UlidSchema,
                workflow_ref: RefSchema,           // @workflow-id reference
                status: 'active' | 'paused' | 'completed' | 'aborted',
                current_step: number,              // 0-indexed
                total_steps: number,               // Snapshot at creation
                started_at: DateTimeSchema,
                paused_at?: DateTimeSchema,
                completed_at?: DateTimeSchema,
                step_results: StepResultSchema[],
                initiated_by?: string,             // getAuthor()
                abort_reason?: string,
                task_ref?: RefSchema,              // Optional task link
              }

              ```


              ### StepResultSchema

              ```typescript

              {
                step_index: number,
                status: 'completed' | 'skipped' | 'failed',
                started_at: DateTimeSchema,
                completed_at: DateTimeSchema,
                entry_confirmed?: boolean,
                exit_confirmed?: boolean,
                notes?: string,
                inputs?: Record<string, string>,
              }

              ```


              ### WorkflowRunsFileSchema

              ```typescript

              {
                kynetic_runs: '1.0',
                runs: WorkflowRun[],
              }

              ```


              ### Extended WorkflowSchema

              Add field: `enforcement?: 'advisory' | 'strict'` (default: advisory)


              ## Storage Operations


              File: `src/parser/meta.ts`


              - `loadWorkflowRuns()`: Load from .kspec/kynetic.runs.yaml

              - `saveWorkflowRun(run)`: Create new run, shadow commit

              - `updateWorkflowRun(run)`: Update existing, shadow commit

              - `findWorkflowRunByRef(ref)`: Find by ULID prefix


              Shadow commit messages: workflow-start, workflow-abort


              ## CLI Commands


              - `kspec workflow start @ref [--task @ref] [--json]`

              - `kspec workflow runs [--active] [--completed] [--workflow @ref] [--json]`

              - `kspec workflow show @run [--json]`

              - `kspec workflow abort @run [--reason text] [--json]`


              ## Key Files


              - src/schema/meta.ts (add schemas)

              - src/parser/meta.ts (add storage functions)

              - src/cli/commands/workflow.ts (new file)

              - src/strings/errors.ts (add error messages)
            depends_on: []
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-json-output"
              - "@trait-filterable-list"
              - "@trait-error-guidance"
            notes: []
            created: 2026-01-20T22:53:32.314Z
            acceptance_criteria:
              - id: ac-1
                given: a workflow exists
                when: kspec workflow start @ref is executed
                then: creates WorkflowRun in .kspec/kynetic.runs.yaml with status=active, current_step=0,
                  total_steps from workflow, started_at; outputs run ID
              - id: ac-2
                given: workflow runs exist
                when: kspec workflow runs is executed
                then: "outputs table with: ID (short ULID), Workflow, Status, Step (N/M), Started; supports
                  --active, --completed, --workflow filters"
              - id: ac-3
                given: an active run exists
                when: kspec workflow abort @run-id --reason '...' is executed
                then: status=aborted, abort_reason recorded, completed_at set; shadow committed
              - id: ac-4
                given: a workflow run exists
                when: kspec workflow show @run-id is executed
                then: "outputs run details: workflow_ref, status, current_step/total_steps, step_results with
                  timestamps, initiated_by"
              - id: ac-5
                given: a run with status=completed or status=aborted exists
                when: kspec workflow abort @run-id is executed
                then: errors indicating run cannot be aborted in current state
              - id: ac-6
                given: a workflow and task exist
                when: kspec workflow start @workflow --task @task-ref is executed
                then: creates run with task_ref field set, linking run to task context
            status:
              maturity: draft
              implementation: implemented
          - _ulid: 01KFESTXHYVDTW4X0Y13RN78K3
            slugs:
              - workflow-step-navigation
            title: Workflow Step Navigation
            type: requirement
            tags: []
            description: |-
              Step-by-step progression through workflow runs via the next command.

              ## Command

              `kspec workflow next [run-ref] [--skip] [--notes text] [--json]`

              ## Behavior

              1. If no run-ref provided:
                 - Find active runs
                 - If exactly one: use it (AC inference)
                 - If multiple: error with list of run IDs to choose from
                 - If none: error 'No active workflow runs'

              2. Complete current step:
                 - Record StepResult with status='completed' (or 'skipped' if --skip)
                 - Set started_at to previous step's completed_at (or run's started_at for step 0)
                 - Set completed_at to now
                 - Capture --notes if provided

              3. Advance to next step:
                 - Increment current_step
                 - Display next step with [type] prefix and content

              4. If was last step:
                 - Set run status='completed'
                 - Set completed_at
                 - Output summary: total duration, steps completed, steps skipped

              ## Output Format

              ```
              Completed step 1/5: [check] Does the spec cover this change?

              Step 2/5: [action] Update spec if needed
              ```

              ## Key Files

              - src/cli/commands/workflow.ts (add next subcommand)
              - src/parser/meta.ts (findActiveRuns helper)

              ## Dependencies

              Requires @workflow-run-foundation to be implemented first.
            depends_on: []
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-json-output"
              - "@trait-error-guidance"
            notes: []
            created: 2026-01-20T22:54:02.814Z
            acceptance_criteria:
              - id: ac-1
                given: an active run exists
                when: kspec workflow next @run-id is executed
                then: completes current step (records in step_results), shows next step; if last step, completes run
              - id: ac-2
                given: a run is at the last step
                when: kspec workflow next @run-id is executed
                then: status=completed, completed_at set, outputs summary with total duration and step counts
              - id: ac-3
                given: no run-id provided and one active run exists
                when: kspec workflow next is executed
                then: infers the single active run and operates on it
              - id: ac-4
                given: no run-id provided and multiple active runs exist
                when: kspec workflow next is executed
                then: errors with list of active runs to choose from
              - id: ac-5
                given: no run-id provided and no active runs exist
                when: kspec workflow next is executed
                then: errors with message 'No active workflow runs'
              - id: ac-6
                given: an active run exists
                when: kspec workflow next @run-id --notes 'Note text' is executed
                then: step_results.notes contains the note text for completed step
            status:
              maturity: draft
              implementation: implemented
          - _ulid: 01KFESVX00JT6YJ406QX5N63XQ
            slugs:
              - workflow-enforcement-modes
            title: Workflow Enforcement Modes
            type: requirement
            tags: []
            description: |-
              Entry/exit criteria display and enforcement modes (advisory vs strict).

              ## Extended WorkflowStepSchema

              Add fields to WorkflowStepSchema in src/schema/meta.ts:
              ```typescript
              entry_criteria?: string[],  // Conditions before step
              exit_criteria?: string[],   // Conditions after step
              ```

              ## Behavior

              ### Advisory Mode (default)

              When workflow.enforcement is 'advisory' or omitted:
              - Entry criteria displayed when showing next step
              - Exit criteria displayed after completing step
              - --skip allowed without --force
              - Criteria are guidance only, not blocking

              ### Strict Mode

              When workflow.enforcement is 'strict':
              - Entry criteria must be confirmed with --confirm flag to proceed
              - Exit criteria must be confirmed with --confirm flag to advance
              - --skip requires --force flag
              - Record entry_confirmed/exit_confirmed in StepResult

              ## Output Format

              ```
              Step 2/5: [action] Update spec if needed
                Entry criteria:
                  - Spec coverage has been checked
                  - Change scope is understood
                Exit criteria:
                  - Spec reflects intended behavior change
              ```

              In strict mode without --confirm:
              ```
              error: Entry criteria not confirmed. Use --confirm to acknowledge.
              ```

              ## CLI Flags

              Add to `kspec workflow next`:
              - `--confirm`: Acknowledge entry/exit criteria (required in strict mode)
              - `--force`: Allow --skip in strict mode

              ## Key Files

              - src/schema/meta.ts (extend WorkflowStepSchema)
              - src/cli/commands/workflow.ts (criteria display, enforcement)

              ## Dependencies

              Requires @workflow-step-navigation to be implemented first.
            depends_on: []
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-json-output"
            notes: []
            created: 2026-01-20T22:54:35.008Z
            acceptance_criteria:
              - id: ac-1
                given: a step has entry_criteria defined
                when: kspec workflow next reaches that step
                then: outputs entry criteria; in strict mode blocks until --confirm passed
              - id: ac-2
                given: a step has exit_criteria defined
                when: kspec workflow next completes the step
                then: outputs exit criteria; in strict mode blocks without --confirm
              - id: ac-3
                given: workflow.enforcement=strict and step has criteria
                when: kspec workflow next is executed
                then: requires --confirm to proceed; --skip requires --force; records confirmations in step_results
              - id: ac-4
                given: workflow.enforcement=advisory (or omitted)
                when: kspec workflow next is executed
                then: shows criteria as guidance only; skip allowed without --force
            status:
              maturity: draft
              implementation: implemented
          - _ulid: 01KFESWWBX1QYPJTNJBW3YHHZN
            slugs:
              - workflow-advanced-features
            title: Workflow Advanced Features
            type: requirement
            tags: []
            description: |-
              Pause/resume functionality and structured step inputs.

              ## Pause/Resume Commands

              ```
              kspec workflow pause @run-id [--json]
              kspec workflow resume @run-id [--json]
              ```

              ### Pause Behavior
              - Set status='paused'
              - Set paused_at timestamp
              - Shadow commit with 'workflow-pause' message
              - Output: 'Paused run @id at step N/M'

              ### Resume Behavior
              - Verify status='paused' (error if not)
              - Set status='active'
              - Clear paused_at
              - Shadow commit with 'workflow-resume' message
              - Output current step ready to continue

              ## Structured Step Inputs

              ### StepInputSchema
              ```typescript
              {
                name: string,           // e.g., 'spec_ref'
                description?: string,   // Human explanation
                required?: boolean,     // Default true
                type?: 'string' | 'ref' | 'number',  // Default 'string'
              }
              ```

              ### Extended WorkflowStepSchema
              Add field: `inputs?: StepInput[]`

              ### CLI
              Add to `kspec workflow next`:
              - `--input key=value` (repeatable)

              ### Behavior
              1. When step has inputs defined, display them:
                 ```
                 Step 3/5: [action] Derive task from spec
                   Inputs required:
                     - spec_ref (ref): Reference to the spec item
                 ```

              2. If required input missing: error 'Missing required input: spec_ref'

              3. Captured inputs stored in step_results.inputs:
                 ```typescript
                 { spec_ref: '@my-feature' }
                 ```

              ## Key Files

              - src/schema/meta.ts (StepInputSchema, extend WorkflowStepSchema)
              - src/cli/commands/workflow.ts (pause, resume, --input flag)

              ## Dependencies

              Requires @workflow-step-navigation to be implemented first.
            depends_on: []
            implements: []
            relates_to: []
            tests: []
            traits:
              - "@trait-json-output"
            notes: []
            created: 2026-01-20T22:55:07.133Z
            acceptance_criteria:
              - id: ac-1
                given: an active run exists
                when: kspec workflow pause @run-id is executed
                then: status=paused, paused_at set; can resume later
              - id: ac-2
                given: a paused run exists
                when: kspec workflow resume @run-id is executed
                then: status=active, paused_at cleared, continues from current_step
              - id: ac-3
                given: a step defines inputs
                when: kspec workflow next @run-id is executed
                then: outputs required inputs; --input key=value captures input in step_results.inputs; errors if
                  required input missing
              - id: ac-4
                given: a run with status other than paused exists
                when: kspec workflow resume @run-id is executed
                then: errors indicating run is not paused, shows current status
            status:
              maturity: draft
              implementation: in_progress
  - _ulid: 01KF1XCNV00000000000000000
    slugs:
      - convention-definitions
      - conventions
    title: Convention Definitions
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: medium
    tags:
      - meta
      - conventions
    description: |
      Conventions are project-specific rules and standards. They cover
      naming, formatting, commit style, note-writing, etc. Structured
      conventions can be validated where possible.
    acceptance_criteria:
      - id: ac-conv-1
        given: conventions are defined in meta manifest
        when: kspec meta conventions runs
        then: >
          outputs table with columns: Domain, Rules (count), Validation (yes/no); one row per
          convention; exit code 0
      - id: ac-conv-2
        given: kspec meta conventions --domain commits runs
        when: a commits convention exists
        then: |
          outputs only the commits convention with full rules list and examples
      - id: ac-conv-3
        given: a convention has validation.type=regex
        when: kspec validate --conventions runs
        then: >
          applies regex pattern to relevant content; reports violations with line/location and
          expected format
      - id: ac-conv-4
        given: a convention has validation.type=prose
        when: kspec validate --conventions runs
        then: |
          skips validation; outputs info: "Skipping prose convention: <domain>"
      - id: ac-conv-5
        given: kspec meta conventions --json runs
        when: conventions are defined
        then: >
          outputs JSON array with objects containing: domain, rules (array), examples (array),
          validation (object or null)
    requirements:
      - _ulid: 01KF1XCNV10000000000000000
        slugs:
          - convention-schema
        title: Convention Schema
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Convention definition structure:

          ```yaml
          - _ulid: 01KF...
            domain: commits       # Area this convention covers
            rules:
              - Use conventional commit format
              - Reference task in commit body when applicable
              - Keep subject line under 72 characters
            examples:
              - good: "feat: add user login flow"
                bad: "Added login"
              - good: "fix(auth): handle expired tokens"
                bad: "fixed bug"
          ```

          Domains: commits, notes, naming, tags, etc.
          Examples provide concrete guidance.
        implements:
          - "@convention-definitions"
      - _ulid: 01KF1XCNV20000000000000000
        slugs:
          - convention-domains
        title: Convention Domains
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Standard convention domains:

          - commits: Git commit message format
          - notes: Task note writing style
          - naming: Slug/identifier conventions
          - tags: Tag taxonomy and usage
          - branching: Git branch naming
          - documentation: Doc writing standards

          Projects can define custom domains as needed.
        implements:
          - "@convention-definitions"
      - _ulid: 01KF2XCNV30000000000000000
        slugs:
          - convention-validation
        title: Convention Validation Strategy
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Conventions support optional validation with domain-specific strategies:

          ```yaml
          - _ulid: 01KF...
            domain: commits
            rules:
              - Use conventional commit format
            validation:
              type: regex
              pattern: "^(feat|fix|docs|style|refactor|test|chore)(\\(.+\\))?:\\s.+"
              message: "Commit must follow conventional format"
          ```

          Validation types by domain:

          - commits: regex pattern matching on message
          - notes: word count range, required sections
          - naming: regex pattern for slugs/identifiers
          - tags: enum list of allowed tags
          - branching: regex pattern for branch names
          - documentation: prose (advisory only, no automation)

          Validation configuration:

          ```yaml
          validation:
            type: regex | enum | range | prose
            # For regex:
            pattern: "^pattern$"
            message: "Error message when validation fails"
            # For enum:
            allowed: [value1, value2, value3]
            # For range:
            min: 10
            max: 500
            unit: words | chars | lines
          ```

          Validation is optional - conventions without validation field
          are advisory-only and appear in documentation.

          `kspec validate --conventions` runs all validatable conventions.
          Prose-type conventions are skipped with info message.
        implements:
          - "@convention-definitions"
  - _ulid: 01KF1XFBK00000000000000000
    slugs:
      - observations
      - feedback-loop
    title: Observations
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - meta
      - feedback
    description: |
      Observations capture feedback about workflows and conventions.
      This is the mechanism for the self-improvement loop - agents
      record friction, success, questions, and ideas, then patterns
      emerge that inform workflow improvements.

      Observations can be promoted to tasks with --meta-ref, creating
      trackable work to improve processes.
    acceptance_criteria:
      - id: ac-obs-1
        given: an agent encounters workflow friction
        when: kspec meta observe friction "description" runs
        then: >
          outputs "OK Created observation: <ULID-prefix>"; observation stored with fields: _ulid,
          type, content, created_at (ISO8601), author, resolved (false), workflow_ref (if --workflow
          provided)
      - id: ac-obs-2
        given: observations exist
        when: kspec meta observations runs
        then: >
          outputs table with columns: ID, Type, Workflow, Created, Content (truncated); shows only
          unresolved by default; --all includes resolved
      - id: ac-obs-3
        given: an observation exists
        when: kspec meta promote @obs --title "Task title" runs
        then: >
          creates task with: title from --title, description from observation content, meta_ref from
          observation's workflow_ref; outputs "OK Created task: <ULID-prefix>"; observation updated
          with promoted_to field pointing to new task
      - id: ac-obs-4
        given: an observation exists
        when: kspec meta resolve @obs "resolution text" runs
        then: >
          observation updated with: resolved=true, resolution=text, resolved_at (ISO8601),
          resolved_by (author); outputs "OK Resolved: <ULID-prefix>"
      - id: ac-obs-5
        given: kspec meta observations --json runs
        when: observations exist
        then: |
          outputs JSON array with full observation objects including all fields
      - id: ac-obs-6
        given: an observation has already been promoted (has promoted_to field)
        when: kspec meta promote @obs runs
        then: >
          exits with code 1; error message: "Observation already promoted to task <task-ref>;
          resolve or delete the task first"
      - id: ac-obs-7
        given: an observation is already resolved (resolved=true)
        when: kspec meta resolve @obs runs
        then: >
          exits with code 1; error message: "Observation already resolved on <date>:
          '<resolution-text-truncated>'"
      - id: ac-obs-8
        given: an observation is already resolved
        when: kspec meta promote @obs runs
        then: >
          exits with code 1; error message: "Cannot promote resolved observation; use --force to
          override"
      - id: ac-obs-9
        given: an observation has promoted_to pointing to a completed task
        when: kspec meta resolve @obs runs with no explicit resolution
        then: >
          auto-populates resolution from task completion reason if available; prompts for resolution
          text if task has no completion reason
    requirements:
      - _ulid: 01KF1XFBK10000000000000000
        slugs:
          - observation-schema
        title: Observation Schema
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Observation structure:

          ```yaml
          - _ulid: 01KF...
            type: friction        # friction, success, question, idea
            workflow_ref: "@spec-first"  # Related workflow (optional)
            content: |
              Spec-first check feels heavyweight for typo fixes.
              Interrupts flow for trivial changes.
            created_at: "2025-01-15T10:00:00Z"
            author: "@claude"
            resolved: false
            resolution: null      # Filled when resolved
          ```

          Types capture the nature of the feedback.
          workflow_ref links to relevant workflow for tracking.
        implements:
          - "@observations"
      - _ulid: 01KF1XFBK20000000000000000
        slugs:
          - observation-types
        title: Observation Types
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Observation types:

          - friction: Something that's hard, slow, or frustrating
          - success: Something that works well (positive feedback)
          - question: Uncertainty about how to proceed
          - idea: Potential improvement or new approach

          All types feed the improvement loop. Friction and ideas
          most often lead to workflow changes. Success confirms
          what's working. Questions may reveal documentation gaps.
        implements:
          - "@observations"
      - _ulid: 01KF1XFBK30000000000000000
        slugs:
          - observation-promotion
        title: Observation Promotion
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Observations can be promoted to tasks:

          ```bash
          kspec meta promote @obs-123 \
            --title "Simplify spec-first for trivial changes" \
            --priority 2
          ```

          Creates task with:
          - title from --title
          - meta_ref pointing to related workflow
          - description from observation content
          - origin: observation_promotion

          Original observation marked with promoted_to reference.
        implements:
          - "@observations"
      - _ulid: 01KF1XFBK40000000000000000
        slugs:
          - observation-resolution
        title: Observation Resolution
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Resolving observations:

          ```bash
          kspec meta resolve @obs-123 "Addressed by --quick flag in v0.2"
          ```

          Sets:
          - resolved: true
          - resolution: "Addressed by --quick flag in v0.2"
          - resolved_at: timestamp
          - resolved_by: author

          Resolved observations remain for history.
          Unresolved observations show in session context.
        implements:
          - "@observations"
      - _ulid: 01KF2XFBK50000000000000000
        slugs:
          - observation-task-loop
        title: Observation-Task Resolution Loop
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          The observation→task→resolution loop defines how observations connect
          to tasks and when they get resolved.

          **Promotion creates linkage**:
          When an observation is promoted to a task:
          - observation.promoted_to = @task-ref
          - task.origin = "observation_promotion"
          - task.description includes observation content

          **Task completion does NOT auto-resolve**:
          Completing a task does not automatically resolve linked observations.
          This is intentional:
          - Task might address the observation partially
          - Multiple tasks might be needed
          - Agent should explicitly confirm resolution

          **Explicit resolution required**:
          After completing the task, agent runs:
          ```bash
          kspec meta resolve @obs "Addressed by task @task-ref"
          ```

          **Convenience: resolve-from-task**:
          If observation has promoted_to pointing to a completed task:
          ```bash
          kspec meta resolve @obs
          # Auto-populates: "Resolved via task @task-ref: <task.reason>"
          ```
          Prompts for resolution text if task has no completion reason.

          **Session context reminder**:
          When task with origin="observation_promotion" is completed,
          session context shows reminder:
          "Consider resolving linked observation: @obs-ref"

          **Querying the loop**:
          ```bash
          # Find observations that spawned tasks
          kspec meta observations --promoted

          # Find tasks from observations
          kspec tasks list --origin observation_promotion

          # Find unresolved observations with completed tasks
          kspec meta observations --pending-resolution
          ```

          This explicit loop ensures observations aren't lost when tasks
          complete, and creates traceable process improvement history.
        implements:
          - "@observations"
  - _ulid: 01KF1XCTX00000000000000000
    slugs:
      - session-context
      - context
    title: Session Context
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: medium
    tags:
      - meta
      - context
    description: |
      Session context is ephemeral state tracking current focus,
      active threads, and open questions. Unlike other meta items,
      context is dynamic and stored in a separate file (.kspec-session)
      that can be gitignored.

      Context helps with session continuity and handoff between agents.
    requirements:
      - _ulid: 01KF1XCTX10000000000000000
        slugs:
          - context-schema
        title: Context Schema
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Session context structure:

          ```yaml
          # .kspec-session (gitignored)
          focus: "@task-meta-spec"    # Current work focus
          threads:                     # Active conversation threads
            - "Designing observation promotion flow"
            - "Deciding on context persistence"
          open_questions:              # Unresolved questions
            - "Should conventions be auto-validated?"
            - "How to handle cross-project inheritance?"
          updated_at: "2025-01-15T10:30:00Z"
          ```

          Ephemeral by design - not part of project history.
        implements:
          - "@session-context"
      - _ulid: 01KF1XCTX20000000000000000
        slugs:
          - context-storage
        title: Context Storage
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Context is stored in .kspec-session:

          - Separate from meta manifest (ephemeral vs stable)
          - Gitignored by default (session-specific)
          - Auto-created when context commands used
          - Can be deleted without losing project configuration

          This keeps project-level meta (agents, workflows) separate
          from session-level state (focus, threads).
        implements:
          - "@session-context"
      - _ulid: 01KF1XCTX30000000000000000
        slugs:
          - context-integration
        title: Context Integration
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Context appears in session start output:

          ```
          === Session Context ===
          Focus: @task-meta-spec (Design meta-spec concept)

          Active Threads:
            - Designing observation promotion flow

          Open Questions:
            - Should conventions be auto-validated?
          ```

          Helps agents quickly understand current state.
        implements:
          - "@session-context"
  - _ulid: 01KF1XCMD00000000000000000
    slugs:
      - meta-commands
      - meta-cli
    title: Meta CLI Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - meta
      - cli
    description: |
      CLI commands for interacting with meta-spec. Follow the same
      patterns as existing kspec commands: resource-action structure,
      --json support, semantic exit codes.
    requirements:
      - _ulid: 01KF1XCMD10000000000000000
        slugs:
          - meta-show
        title: kspec meta show
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta show

          Display meta-spec summary:
          - Number of defined agents
          - Number of workflows
          - Number of conventions
          - Unresolved observation count
          - Session context summary

          Quick overview of project process definitions.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMD20000000000000000
        slugs:
          - meta-agents-cmd
        title: kspec meta agents
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta agents [options]

          List defined agents:
          - --json: Structured output
          - --capabilities: Group by capabilities

          Output shows id, name, capabilities for each agent.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMD30000000000000000
        slugs:
          - meta-workflows-cmd
        title: kspec meta workflows
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta workflows [options]

          List defined workflows:
          - --json: Structured output
          - --verbose: Show full steps

          Output shows id, trigger, step count for each workflow.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMD40000000000000000
        slugs:
          - meta-conventions-cmd
        title: kspec meta conventions
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta conventions [options]

          List defined conventions:
          - --json: Structured output
          - --domain <domain>: Filter by domain

          Output shows domain, rule count for each convention.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMD50000000000000000
        slugs:
          - meta-observe-cmd
        title: kspec meta observe
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta observe <type> "content" [options]

          Record an observation:
          - type: friction, success, question, idea
          - content: The observation text

          Options:
          - --workflow <ref>: Link to workflow
          - --json: Return created observation

          Example:
          kspec meta observe friction "Spec-first is slow for typos"
        implements:
          - "@meta-commands"
        acceptance_criteria:
          - id: from-inbox-conversion
            given: An inbox item exists that should have been an observation
            when: User runs kspec meta observe --from-inbox @inbox-ref [--type <type>]
            then: Inbox item content is used to create observation, inbox item is deleted, observation ref is
              returned. Type defaults to 'idea' if not specified.
        notes:
          - _ulid: 01KFAD3FMNYEZP6ZZ98X34E13R
            created_at: 2026-01-19T05:54:34.261Z
            author: "@claude"
            content: >-
              Enhancement: --from-inbox flag for bucket correction


              **Use case:** During triage, items sometimes get captured in the wrong bucket. An idea
              captured as inbox item should have been an observation. This flag allows converting
              without losing the content.


              **Behavior:**

              - --from-inbox @ref takes an inbox item reference

              - Creates observation with inbox item's content

              - Type defaults to 'idea' but can be overridden with --type

              - Deletes inbox item after successful observation creation

              - Preserves original author from inbox item


              **Mutually exclusive:** When --from-inbox is used, the positional <type> and content
              args are ignored (content comes from inbox item).
            supersedes: null
        traits:
          - "@trait-shadow-commit"
      - _ulid: 01KF1XCMD60000000000000000
        slugs:
          - meta-observations-cmd
        title: kspec meta observations
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta observations [options]

          List observations:
          - --type <type>: Filter by type
          - --workflow <ref>: Filter by workflow
          - --unresolved: Only unresolved (default)
          - --all: Include resolved
          - --json: Structured output

          Shows unresolved observations by default.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMD70000000000000000
        slugs:
          - meta-promote-cmd
        title: kspec meta promote
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta promote <ref> [options]

          Promote observation to task:
          - --title <title>: Required task title
          - --priority <n>: Task priority (1-5)
          - --json: Return created task

          Creates task with meta_ref to related workflow.
          Marks observation with promoted_to reference.
        implements:
          - "@meta-commands"
        traits:
          - "@trait-shadow-commit"
      - _ulid: 01KF1XCMD80000000000000000
        slugs:
          - meta-resolve-cmd
        title: kspec meta resolve
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta resolve <ref> "resolution"

          Resolve an observation:
          - ref: Observation reference
          - resolution: How it was addressed

          Sets resolved=true, adds resolution text.

          Example:
          kspec meta resolve @obs-123 "Added --quick flag"
        implements:
          - "@meta-commands"
        traits:
          - "@trait-shadow-commit"
      - _ulid: 01KF1XCMD90000000000000000
        slugs:
          - meta-focus-cmd
        title: kspec meta focus
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta focus [ref]

          Get or set session focus:
          - No args: Show current focus
          - With ref: Set focus to @ref
          - --clear: Clear current focus

          Focus is stored in .kspec-session.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMDA0000000000000000
        slugs:
          - meta-thread-cmd
        title: kspec meta thread
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta thread <action> [text]

          Manage active threads:
          - add "topic": Add thread
          - remove <index>: Remove by index
          - list: Show all threads
          - clear: Remove all threads

          Threads are stored in .kspec-session.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMK00000000000000000
        slugs:
          - meta-question-cmd
        title: kspec meta question
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta question <action> [text]

          Manage open questions:
          - add "question": Add question
          - remove <index>: Remove by index
          - list: Show all questions
          - clear: Remove all questions

          Questions are stored in .kspec-session.
        implements:
          - "@meta-commands"
      - _ulid: 01KF1XCMX00000000000000000
        slugs:
          - meta-context-cmd
        title: kspec meta context
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta context [options]

          Show full session context:
          - Focus
          - Active threads
          - Open questions
          - Last updated

          Options:
          - --json: Structured output
          - --clear: Clear all context

          Reads from .kspec-session.
        implements:
          - "@meta-commands"
      - _ulid: 01KF2XCMG00000000000000000
        slugs:
          - meta-get-cmd
        title: kspec meta get
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta get <ref>

          Get a meta item by reference:
          - Works for any meta item type (agent, workflow, convention, observation)
          - --json: Structured output
          - --yaml: YAML output (default for complex items)

          Example:
          kspec meta get @workflow-spec-first
          kspec meta get @claude

          Unified access to any meta item by reference.
        implements:
          - "@meta-commands"
      - _ulid: 01KF2XCMN00000000000000000
        slugs:
          - meta-list-cmd
        title: kspec meta list
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta list [options]

          List all meta items:
          - --type <type>: Filter by type (agent, workflow, convention, observation)
          - --json: Structured output

          Output shows: ID, Type, Title/Domain/Trigger (context-dependent)

          Complements type-specific commands (meta agents, meta workflows)
          with a unified view of all meta items.
        implements:
          - "@meta-commands"
      - _ulid: 01KF2XCMA00000000000000000
        slugs:
          - meta-add-cmd
        title: kspec meta add
        type: requirement
        status:
          maturity: draft
          implementation: in_progress
        description: |
          kspec meta add <type> [options]

          Add a new meta item:
          - type: agent, workflow, convention (not observation - use meta observe)

          For agents:
          --id <id> --name <name> --capabilities <cap1,cap2>

          For workflows:
          --id <id> --trigger <trigger> --description <desc>

          For conventions:
          --domain <domain> --rules <rule1> --rules <rule2>

          Example:
          kspec meta add agent --id human --name "Human Developer" --capabilities code,review
          kspec meta add workflow --id pr-review --trigger "pull request opened"

          ULID generated automatically. Returns created item reference.
        implements:
          - "@meta-commands"
        acceptance_criteria:
          - id: ac-1
            given: kspec meta add workflow is executed with --steps containing a valid JSON array of workflow
              steps
            when: each step object has required 'type' (check/action/decision) and 'content' fields
            then: workflow is created with provided steps; steps array persists in meta manifest
          - id: ac-2
            given: kspec meta add workflow is executed with --steps containing malformed JSON
            when: JSON.parse fails
            then: command exits with error 'Invalid JSON in --steps' followed by the parse error details
          - id: ac-3
            given: kspec meta add workflow is executed with --steps containing a JSON object (not an array)
            when: the parsed JSON is not an array
            then: command exits with error 'Steps must be a JSON array'
          - id: ac-4
            given: kspec meta add workflow is executed with --steps containing steps with invalid schema
            when: step objects fail WorkflowStepSchema validation (e.g., invalid type, missing content)
            then: "command exits with error 'Invalid workflow steps' showing field path and validation issue
              (e.g., '0.type: Invalid enum value')"
      - _ulid: 01KF2XCMS00000000000000000
        slugs:
          - meta-set-cmd
        title: kspec meta set
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta set <ref> [options]

          Update a meta item:
          - --name <name>: Update name (agents)
          - --description <desc>: Update description
          - --capabilities <caps>: Replace capabilities (agents)
          - --add-capability <cap>: Add capability (agents)
          - --add-step <step>: Append workflow step
          - --add-rule <rule>: Add convention rule

          Example:
          kspec meta set @claude --add-capability design
          kspec meta set @spec-first --description "Updated process"

          Preserves fields not explicitly changed.
        implements:
          - "@meta-commands"
      - _ulid: 01KF2XCMD00000000000000000
        slugs:
          - meta-delete-cmd
        title: kspec meta delete
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec meta delete <ref> [options]

          Delete a meta item:
          - --confirm: Skip confirmation prompt
          - Validates no dangling references before deletion

          Example:
          kspec meta delete @workflow-old
          kspec meta delete @obs-123 --confirm

          Error if item is referenced by tasks (meta_ref) or observations
          (workflow_ref). Use --confirm to override.
        implements:
          - "@meta-commands"
  - _ulid: 01KF1XREF00000000000000000
    slugs:
      - meta-ref
      - meta-task-link
    title: Meta Reference Integration
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - mvp
      - meta
      - tasks
    description: |
      Tasks can reference meta items via meta_ref, just like spec_ref.
      This enables tracking work on process improvements - the key to
      the self-improvement loop.
    acceptance_criteria:
      - id: ac-meta-ref-1
        given: kspec task add --meta-ref @workflow-id runs
        when: the @workflow-id is a valid workflow reference
        then: >
          task created with meta_ref field set to @workflow-id; outputs "OK Created task:
          <ULID-prefix>"
      - id: ac-meta-ref-2
        given: tasks exist with meta_ref fields
        when: kspec tasks list --meta-ref @workflow runs
        then: >
          outputs only tasks where meta_ref matches @workflow; same output format as regular task
          list
      - id: ac-meta-ref-3
        given: kspec task add --meta-ref @invalid-ref runs
        when: the reference does not resolve to a meta item
        then: >
          exits with code 1; error message: "meta_ref '@invalid-ref' does not resolve to a valid
          meta item (agent, workflow, or convention)"
      - id: ac-meta-ref-4
        given: kspec task add --meta-ref @spec-item runs
        when: the reference is a product spec item (not meta)
        then: >
          exits with code 1; error message: "meta_ref '@spec-item' points to a spec item; use
          --spec-ref for product spec references"
    requirements:
      - _ulid: 01KF1XREF10000000000000000
        slugs:
          - task-meta-ref
        title: Task meta_ref Field
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Tasks gain meta_ref field parallel to spec_ref:

          ```yaml
          - _ulid: 01KF...
            title: Simplify spec-first for trivial changes
            type: task
            meta_ref: "@workflow-spec-first"
            status: pending
            ...
          ```

          meta_ref points to workflow, agent, or convention.
          Enables queries like "what tasks improve this workflow?"
        implements:
          - "@meta-ref"
      - _ulid: 01KF1XREF20000000000000000
        slugs:
          - task-add-meta-ref
        title: task add --meta-ref
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec task add gains --meta-ref option:

          ```bash
          kspec task add \
            --title "Add --quick flag to spec-first" \
            --meta-ref @workflow-spec-first \
            --priority 2
          ```

          Creates task with meta_ref linking to meta item.
          Validation ensures meta_ref resolves to valid meta item.
        implements:
          - "@meta-ref"
      - _ulid: 01KF1XREF30000000000000000
        slugs:
          - meta-ref-queries
        title: Meta Reference Queries
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Query tasks by meta_ref:

          ```bash
          kspec tasks list --meta-ref @workflow-spec-first
          ```

          Returns all tasks linked to that workflow.
          Useful for tracking improvement progress.
        implements:
          - "@meta-ref"
      - _ulid: 01KF2XREF40000000000000000
        slugs:
          - meta-ref-validation
        title: Meta Reference Validation
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          meta_ref field validation rules:

          1. **Reference must resolve**: The @ref must point to an existing item
             Error: "meta_ref '@xyz' does not resolve to any item"

          2. **Reference must be meta item**: The resolved item must be a meta
             item (agent, workflow, convention), not a product spec item.
             Error: "meta_ref '@xyz' points to spec item; use --spec-ref instead"

          3. **Type hints** (optional): For stricter validation, meta_ref can
             specify expected type:
             ```yaml
             meta_ref:
               ref: "@spec-first"
               type: workflow  # Validates ref is a workflow
             ```
             Error: "meta_ref '@xyz' expected workflow, got agent"

          4. **Validation timing**: Checked on:
             - `kspec task add --meta-ref`
             - `kspec validate` (full validation)
             - `kspec task set --meta-ref` (updates)

          5. **Circular reference prevention**: meta_ref cannot point to
             the task itself or create reference cycles.

          Implementation: Validation uses the same reference resolution
          as spec_ref, but filters for meta item types. Meta items are
          identified by their source file (kynetic.meta.yaml or meta/ includes)
          or by explicit type markers.
        implements:
          - "@meta-ref"
