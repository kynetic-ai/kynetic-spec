_ulid: 01KF1V1SN0MGR80YA90E7VEM09
slugs:
  - shadow-branch
  - shadow
title: Shadow Branch
type: module
status:
  maturity: draft
  implementation: implemented
description: |
  Shadow branch for transparent spec/task state auto-tracking.
  Uses gitignored worktree (.kspec/) pointing to orphan branch (kspec-meta).
  Separates metadata commits from main branch history.

  Key properties:
  - Shadow branch has files at root (not nested under spec/)
  - .kspec/ is a git worktree pointing to the shadow branch
  - Main branch gitignores .kspec/
  - All kspec read/write operations target .kspec/
  - Changes auto-commit to shadow branch
features:
  - _ulid: 01KF1V1Z87Z7PTG4C68QSMK4EE
    slugs:
      - shadow-concept
    title: Shadow Branch Concept
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - infrastructure
      - git
    description: |
      Orphan git branch storing kspec state in gitignored worktree.

      Problem solved:
      - Commit bloat from task state changes
      - History pollution on main branch
      - Review noise in PRs

      Solution:
      - Orphan branch (kspec-meta) with files at root
      - .kspec/ worktree always available
      - Auto-commit on state changes
      - Main branch never touched by kspec operations
    requirements:
      - _ulid: 01KF1V1ZJBRPWKF16HEPQG7KHX
        slugs:
          - shadow-structure
        title: Shadow Directory Structure
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Directory layout for shadow branch:

          project/
            .kspec/                    # Git worktree (gitignored by main)
              .git -> ../.git/worktrees/.kspec
              kynetic.yaml             # Root manifest
              kynetic.tasks.yaml       # Tasks
              kynetic.meta.yaml        # Meta-spec
              project.tasks.yaml       # Project tasks
              project.inbox.yaml       # Inbox
              modules/
                core.yaml
                cli.yaml
                shadow.yaml
            src/                       # Normal source (on main branch)
            tests/
            .gitignore                 # Contains: .kspec/

          Shadow branch contents (at root):
          - kynetic.yaml - manifest
          - *.tasks.yaml - task files
          - *.inbox.yaml - inbox files
          - modules/*.yaml - spec modules
        implements:
          - "@shadow-concept"
      - _ulid: 01KF1V1ZTYSNNVT5WP56VCP5YB
        slugs:
          - shadow-autocommit
        title: Auto-Commit on State Changes
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |-
          All state-changing kspec commands automatically commit to shadow branch.

          Commit messages by command:

          Task lifecycle:
          - task start @ref      -> "Start @{slug}"
          - task complete @ref   -> "Complete @{slug}: {reason}"
          - task block @ref      -> "Block @{slug}"
          - task unblock @ref    -> "Unblock @{slug}"
          - task cancel @ref     -> "Cancel @{slug}"
          - task set @ref        -> "Update @{slug}"

          Task notes/todos:
          - task note @ref       -> "Note on @{slug}"
          - task add             -> "Add task: {title}"
          - task todo add        -> "Todo on @{slug}"
          - task todo done       -> "Todo done on @{slug}"
          - task todo undone     -> "Todo undone on @{slug}"

          Inbox:
          - inbox add            -> "Inbox: {text}"
          - inbox promote        -> "Promote to @{slug}"
          - inbox delete         -> "Inbox delete"

          Items:
          - item add/set/delete  -> "{action} @{slug}"
          - item ac add          -> "AC on @{slug}"
          - item ac set          -> "AC update on @{slug}"
          - item ac remove       -> "AC remove on @{slug}"

          Derive:
          - derive               -> "Derive from @{spec}"

          Implementation:
          - After write, run: git -C .kspec add -A && git -C .kspec commit -m "..."
          - Low overhead (local commits only)
          - Commit includes all changes from the operation
        implements:
          - "@shadow-concept"
        acceptance_criteria:
          - id: ac-1
            given: shadow branch is enabled and task @my-task exists
            when: kspec task start/complete/block/unblock/cancel/set runs
            then: shadow branch has new commit with appropriate message
          - id: ac-2
            given: shadow branch is enabled and task @my-task exists
            when: kspec task note/add or task todo add/done/undone runs
            then: shadow branch has new commit with appropriate message
          - id: ac-3
            given: shadow branch is enabled
            when: kspec inbox add/promote/delete runs
            then: shadow branch has new commit with appropriate message
          - id: ac-4
            given: shadow branch is enabled
            when: kspec item add/set/delete or item ac add/set/remove runs
            then: shadow branch has new commit with appropriate message
          - id: ac-5
            given: shadow branch is enabled and spec item @my-spec exists
            when: kspec derive @my-spec runs
            then: shadow branch has new commit with message containing the spec ref
          - id: ac-6
            given: shadow branch is enabled but commit fails (e.g., git error)
            when: any state-changing command runs
            then: command still succeeds, commit failure is silently ignored
      - _ulid: 01KF1V2027DTBEBN6A6DCBAT1Q
        slugs:
          - shadow-read-path
        title: Shadow Read Path
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          All kspec read operations target .kspec/ directory.

          Affected operations:
          - kspec tasks ready
          - kspec session start
          - kspec item get
          - kspec validate
          - All other reads

          Implementation:
          - Parser loads YAML from .kspec/kynetic.yaml and includes
          - Ref resolution uses .kspec/ file paths
          - Source file tracking uses .kspec/ paths
        implements:
          - "@shadow-concept"
      - _ulid: 01KF1V209B3C1C7AB3Y63SPSPB
        slugs:
          - shadow-write-path
        title: Shadow Write Path
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          All kspec write operations target .kspec/ directory.

          - YAML files written to .kspec/
          - After write, auto-commit triggered
          - No interaction with main branch's working tree
        implements:
          - "@shadow-concept"
      - _ulid: 01KF1V20H5PEMHYR3AEA9FQF6T
        slugs:
          - shadow-errors
        title: Shadow Error Messages
        type: requirement
        status:
          maturity: draft
          implementation: verified
        description: |
          Clear error messages for common failure scenarios:

          - "Shadow branch not initialized. Run `kspec init` to create."
          - "Worktree disconnected. Run `kspec shadow repair` to fix."
          - ".kspec/ directory missing. Run `kspec shadow repair` to recreate."

          Errors should be actionable with clear next steps.
        implements:
          - "@shadow-concept"
        acceptance_criteria:
          - id: ac-1
            given: Git repo exists but shadow branch has never been initialized
            when: User runs a kspec command that requires shadow (e.g., task list)
            then: Error message says 'Shadow branch not initialized' and suggests 'Run kspec init to create'
          - id: ac-2
            given: Shadow branch exists but .kspec/.git file is missing or corrupt
            when: User runs a kspec command
            then: Error message says 'Worktree disconnected' and suggests 'Run kspec shadow repair to fix'
          - id: ac-3
            given: Shadow branch exists but .kspec/ directory is deleted
            when: User runs a kspec command
            then: Error message says '.kspec/ directory missing' and suggests 'Run kspec shadow repair to
              recreate'
          - id: ac-4
            given: User is inside the .kspec/ directory (cwd is .kspec/)
            when: User runs any kspec command
            then: Error message says 'Cannot run kspec from inside .kspec/ directory' and suggests running from
              project root
          - id: ac-5
            given: Any shadow-related error occurs
            when: Error is displayed to user
            then: Error includes specific command to run to fix the issue
      - _ulid: 01KF3CTXYNWH7TQMJNQZR0HHA9
        slugs:
          - shadow-debug-mode
        title: Shadow Debug Mode
        type: requirement
        tags:
          - dx
          - cli
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T12:35:12.982Z
        description: |-
          Optional verbose output for shadow branch operations.

          By default, auto-commit failures are silent (see @shadow-autocommit ac-6).
          Debug mode surfaces these errors for troubleshooting.

          Enable via:
          - KSPEC_DEBUG=1 environment variable
          - --debug-shadow flag on any command

          When enabled:
          - Auto-commit failures are reported to stderr
          - Git operations show underlying commands
          - Useful for diagnosing worktree/branch issues
        acceptance_criteria:
          - id: ac-1
            given: KSPEC_DEBUG=1 is set and auto-commit fails
            when: any state-changing command runs
            then: error message is printed to stderr
          - id: ac-2
            given: --debug-shadow flag is passed and auto-commit fails
            when: any state-changing command runs
            then: error message is printed to stderr
          - id: ac-3
            given: debug mode is not enabled
            when: auto-commit fails
            then: no error output is shown (silent failure)
        status:
          maturity: draft
          implementation: verified
  - _ulid: 01KF1V20REJ21SN3JPGXQ9NM25
    slugs:
      - shadow-init
    title: Shadow Initialization
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - infrastructure
      - cli
    description: |
      kspec init creates shadow branch and worktree by default.

      Steps:
      1. Add .kspec/ to .gitignore and commit (fails if .gitignore is dirty)
      2. Create git worktree at .kspec/ with orphan branch kspec-meta
      3. Create initial manifest and structure in .kspec/
      4. Initial commit on shadow branch
    acceptance_criteria:
      - id: ac-shadow-init-1
        given: a git repository without shadow branch
        when: kspec init runs
        then: orphan branch kspec-meta is created
      - id: ac-shadow-init-2
        given: kspec init has run
        when: checking .kspec/ directory
        then: it is a valid git worktree pointing to kspec-meta
      - id: ac-shadow-init-3
        given: kspec init has run
        when: checking git log
        then: .gitignore change is committed to main branch
      - id: ac-shadow-init-4
        given: shadow branch already exists
        when: kspec init runs again
        then: it succeeds without error (idempotent)
      - id: ac-shadow-init-5
        given: .gitignore has uncommitted changes
        when: kspec init runs
        then: it fails with error explaining the issue
    implements:
      - "@cmd-init"
    requirements:
      - _ulid: 01KF1V20ZWB6DG3DAYKHMHM0XN
        slugs:
          - shadow-ci
        title: CI/CD Integration
        type: constraint
        status:
          maturity: draft
          implementation: implemented
        description: |
          CI environments need shadow worktree before running kspec commands.

          CI setup:
            git worktree add .kspec kspec-meta

          This must be documented in generated README or kspec docs.
          The worktree is not committed to git, so CI must recreate it.
        implements:
          - "@shadow-init"
          - "@cmd-init"
    features:
      - _ulid: 01KF47G9P4VFQZR8MX8WPN3YZ0
        slugs:
          - shadow-init-remote
        title: Init Remote Detection
        type: feature
        tags: []
        description: When running kspec init in a fresh clone, automatically detect if kspec-meta branch
          exists on remote and attach to it rather than creating a new orphan branch.
        depends_on: []
        implements: []
        relates_to: []
        tests: []
        created: 2026-01-16T20:21:16.100Z
        acceptance_criteria:
          - id: ac-1
            given: git remote origin exists and origin/kspec-meta branch exists
            when: user runs kspec init
            then: creates worktree from remote branch with tracking configured
          - id: ac-2
            given: git remote origin exists but origin/kspec-meta does not exist
            when: user runs kspec init
            then: creates orphan branch locally, pushes to remote to establish tracking
          - id: ac-3
            given: no git remote configured
            when: user runs kspec init
            then: creates orphan branch locally without remote tracking (current behavior)
          - id: ac-4
            given: origin remote exists
            when: checking for remote shadow branch
            then: runs git fetch origin to ensure remote refs are up to date
        status:
          maturity: draft
          implementation: implemented
  - _ulid: 01KF1V217AVWW2EFF87A6M5EGY
    slugs:
      - shadow-cli
    title: Shadow CLI Commands
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: medium
    tags:
      - cli
    description: |
      CLI commands for shadow branch management.
      Minimal surface: status, log, repair.
    implements:
      - "@cli"
    requirements:
      - _ulid: 01KF1V21EKDF1VB0BMTHRAH59Z
        slugs:
          - shadow-status-cmd
        title: Shadow Status Command
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec shadow status

          Shows shadow branch health and statistics:

          $ kspec shadow status
          Shadow Branch: kspec-meta
          Worktree: .kspec/
          Status: healthy

          Commits: 147 total
          Last commit: 2 minutes ago
            "Note on @impl-login"

          Checks performed:
          - Worktree exists and is valid
          - Shadow branch exists
          - No uncommitted changes (should be none with auto-commit)
        implements:
          - "@shadow-cli"
      - _ulid: 01KF1V21P816NQFKF0C8426M0D
        slugs:
          - shadow-log-cmd
        title: Shadow Log Command
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec shadow log [-n <limit>] [--oneline]

          Shows shadow branch commit history:

          $ kspec shadow log
          abc123 2m ago   Note on @impl-login
          def456 5m ago   Complete @task-validation
          ghi789 1h ago   Start @impl-login
          ...

          Options:
          - -n, --limit <n>: Number of commits to show
          - --oneline: Compact format
          - --json: Structured output
        implements:
          - "@shadow-cli"
  - _ulid: 01KF1VBPN5J53QJJM3FTXK2J9R
    slugs:
      - shadow-recovery
    title: Shadow Recovery
    type: feature
    status:
      maturity: draft
      implementation: implemented
    priority: high
    tags:
      - infrastructure
      - reliability
    description: |
      Recovery mechanisms for shadow branch issues. Provides CLI commands for
      diagnosing and repairing shadow branch problems.

      Commands:
      - `shadow status`: Check health of shadow branch
      - `shadow repair`: Recreate worktree when branch exists but worktree broken
      - `shadow log`: View recent commits on shadow branch

      Handles common issues:
      - Worktree directory deleted (recreate from existing branch)
      - Worktree disconnected from git (remove and recreate)
      - Stale worktree references in git
    acceptance_criteria:
      - id: ac-recovery-1
        given: shadow branch exists but .kspec/ directory is deleted
        when: kspec shadow repair runs
        then: worktree is recreated from existing branch
      - id: ac-recovery-2
        given: .kspec/ exists but .git file is missing or corrupt
        when: kspec shadow repair runs
        then: worktree is removed and recreated
      - id: ac-recovery-3
        given: shadow branch does not exist
        when: kspec shadow repair runs
        then: it fails with error suggesting kspec init
      - id: ac-recovery-4
        given: shadow branch is healthy
        when: kspec shadow repair runs
        then: it succeeds without changes (idempotent)
      - id: ac-recovery-5
        given: shadow branch is healthy
        when: kspec shadow status runs
        then: it reports healthy status with all checks passing
      - id: ac-recovery-6
        given: shadow branch has issues
        when: kspec shadow status runs
        then: it reports the specific issue and suggests repair
    requirements:
      - _ulid: 01KF1VBR1XMKDJ0K5HYW7RWGQE
        slugs:
          - shadow-repair-cmd
        title: Shadow Repair Command
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          kspec shadow repair

          Re-establishes worktree if .kspec/ is deleted or corrupted:
          - Recreates worktree link from .git/worktrees/.kspec
          - Detects and reports common corruption scenarios
          - Handles: stale locks, orphaned worktrees, detached HEAD

          Acceptance criteria:
          - Recovers from deleted .kspec/ directory
          - Reports clear error if shadow branch itself is missing
          - Idempotent (safe to run multiple times)
        implements:
          - "@shadow-recovery"
      - _ulid: 01KF1VBRG99HYJ00CVABVKV0QM
        slugs:
          - shadow-validation
        title: Shadow Branch Validation
        type: requirement
        status:
          maturity: draft
          implementation: implemented
        description: |
          Shadow validation as part of kspec validate.

          Checks:
          - Worktree exists and is properly linked
          - Shadow branch exists and is reachable
          - No uncommitted changes (should be zero with auto-commit)
          - All spec files valid YAML with correct schema
        implements:
          - "@shadow-recovery"
  - _ulid: 01KF47F4J7DAQ3TD3BGHFQSK9C
    slugs:
      - shadow-sync
    title: Shadow Remote Sync
    type: feature
    tags: []
    description: Automatic synchronization of shadow branch with remote repository. After each local
      auto-commit, attempt push to remote. On session start or read operations, pull remote changes
      first.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    created: 2026-01-16T20:20:38.087Z
    acceptance_criteria:
      - id: ac-1
        given: remote tracking is configured for shadow branch
        when: a state-changing operation commits to shadow branch
        then: kspec attempts to push to remote (fire-and-forget, errors ignored)
      - id: ac-2
        given: remote tracking is configured
        when: session start runs
        then: kspec pulls remote changes before showing session context
      - id: ac-3
        given: pull encounters a conflict
        when: sync is attempted
        then: local operation succeeds, warning displayed, user directed to run kspec shadow resolve
      - id: ac-4
        given: no remote tracking configured
        when: sync would normally occur
        then: sync is silently skipped (no error)
      - id: ac-5
        given: shadow branch has unresolved sync conflict
        when: user runs kspec shadow resolve
        then: interactive conflict resolution guides user through resolving conflicts
      - id: ac-6
        given: sync uses git pull
        when: pulling remote changes
        then: uses --ff-only first, falls back to --rebase if needed
      - id: ac-7
        given: new shadow branch is created and origin remote exists
        when: initializeShadow completes
        then: tracking is configured to origin/kspec-meta regardless of push success
      - id: ac-8
        given: shadow branch exists without tracking and main branch has origin remote
        when: any sync operation is attempted
        then: tracking is automatically configured to origin/kspec-meta
    status:
      maturity: draft
      implementation: implemented
  - _ulid: 01KFM78SSTQR07F36DKWJS85ZY
    slugs:
      - yaml-merge-driver
    title: Semantic YAML Merge Driver
    type: feature
    tags: []
    description: >-
      A custom git merge driver that parses both versions of kspec YAML files and merges them
      semantically, understanding the structure of tasks, items, and other kspec entities. This
      prevents git from creating conflict markers that would corrupt YAML files.


      Note on exit codes: This command intentionally does NOT use @trait-semantic-exit-codes because
      git merge drivers have special requirements - they must exit 0 to prevent git from falling
      back to its text merge, which would corrupt YAML.
    depends_on: []
    implements: []
    relates_to: []
    tests: []
    traits:
      - "@trait-dry-run"
      - "@trait-error-guidance"
    notes: []
    created: 2026-01-23T01:25:01.370Z
    acceptance_criteria:
      - id: ac-1
        given: git attempts to merge two versions of a kspec YAML file
        when: the merge driver is configured
        then: kspec parses all three versions (base, ours, theirs) as structured data instead of text
      - id: ac-2
        given: both versions add different items to an array (tasks, inbox, specs)
        when: merge runs
        then: both additions are included in result (union merge by ULID)
      - id: ac-3
        given: both versions modify different fields of the same item
        when: merge runs
        then: fields are merged (non-conflicting field changes combined)
      - id: ac-4
        given: both versions modify the same scalar field (title, description, priority) of the same item
        when: merge runs
        then: user is prompted interactively to choose which value to keep
      - id: ac-5
        given: both versions modify append-only arrays (notes, todos)
        when: merge runs
        then: arrays are union merged by ULID (notes never conflict)
      - id: ac-6
        given: both versions modify set-like arrays (tags, depends_on)
        when: merge runs
        then: arrays are set-unioned (duplicates removed)
      - id: ac-7
        given: both versions modify nested objects (status, traceability)
        when: merge runs
        then: nested fields are merged recursively at field level
      - id: ac-8
        given: one version deletes an item while other modifies it
        when: merge runs
        then: user is prompted interactively to choose delete vs keep modified
      - id: ac-9
        given: merge completes with no true conflicts
        when: driver exits
        then: exit code 0, merged YAML written to output path
      - id: ac-10
        given: merge has unresolvable conflicts and --non-interactive flag set
        when: driver exits
        then: conflict markers written as YAML comments, exit code 0 (prevents git fallback)
      - id: ac-11
        given: YAML parsing fails on any input file
        when: driver runs
        then: "falls back gracefully: copies ours verbatim, creates .kspec-merge-failed marker, exits 0"
